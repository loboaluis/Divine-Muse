<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divine Muses</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* Light gray background */
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; /* 10% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 90%; /* Adjusted for better mobile fit */
            max-width: 500px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        /* Product Detail Modal Styles */
        .product-detail-modal {
            display: none;
            position: fixed;
            z-index: 1000; /* Higher z-index to be on top of other modals */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Dark translucent background */
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px); /* Optional: blur effect for modern browsers */
        }
        .product-detail-modal-content {
            background-color: #fff;
            border-radius: 0.75rem; /* More rounded */
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: flex; /* Flexbox for image and details side by side */
            width: 95%; /* Adjusted for better mobile fit */
            max-width: 900px; /* Max width for the Instagram-like feed */
            max-height: 95vh; /* Limit height to viewport height */
            position: relative; /* For close button positioning */
        }
        .product-detail-image-section {
            flex: 1; /* Takes half width */
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f0f0; /* Light background for images */
        }
        .product-detail-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Ensures the whole image is visible */
        }
        .product-detail-image-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
        }
        .product-detail-image-nav button {
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: #333;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .product-detail-image-nav button:hover {
            background-color: rgba(255, 255, 255, 1);
        }
        .product-detail-dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
        }
        .product-detail-dot {
            width: 8px;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.2);
        }
        .product-detail-dot.active {
            background-color: #ec4899; /* Pink */
        }

        .product-detail-info-section {
            flex: 1; /* Takes half width */
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }
        .product-detail-info-section h3 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #ec4899; /* Pink */
        }
        .product-detail-info-section .price-display {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .product-detail-info-section .original-price {
            text-decoration: line-through;
            color: #9ca3af; /* Gray */
            margin-right: 0.75rem;
            font-size: 1.2rem;
        }
        .product-detail-info-section .discounted-price {
            color: #ef4444; /* Red */
        }
        .product-detail-info-section p {
            margin-bottom: 1rem;
            color: #4b5563;
            flex-grow: 1; /* Allow description to take space */
            overflow-y: auto; /* Scroll for long descriptions */
        }
        .product-detail-accessories {
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .product-detail-accessories h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .product-detail-accessories-list span {
            display: inline-block;
            background-color: #e5e7eb;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        /* New: Product Detail Options (for both Sizes and Colors) */
        .product-detail-options {
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .product-detail-options h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .product-detail-size-item, .product-detail-color-item {
            display: inline-block;
            background-color: #e5e7eb;
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .product-detail-size-item:hover, .product-detail-color-item:hover {
            background-color: #d1d5db;
        }
        .product-detail-size-item.selected, .product-detail-color-item.selected {
            background-color: #ec4899; /* Pink */
            color: white;
            border-color: #db2777;
        }
        /* Specific style for color circles */
        .product-detail-color-circle {
            width: 32px; /* Adjusted size */
            height: 32px; /* Adjusted size */
            border-radius: 50%;
            border: 2px solid transparent; /* Default transparent border */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            flex-shrink: 0; /* Prevent shrinking in flex container */
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Subtle shadow */
        }
        .product-detail-color-circle.selected {
            border-color: #ec4899 !important; /* Pink border for selected */
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.5); /* Optional: subtle glow */
        }
        /* Add a subtle grey border for light colors to make them visible */
        .product-detail-color-circle[style*="background-color: white"],
        .product-detail-color-circle[style*="background-color: #ffffff"],
        .product-detail-color-circle[data-color="Blanco"] {
            border-color: #ccc;
        }
        .product-detail-color-circle.selected[style*="background-color: white"],
        .product-detail-color-circle.selected[style*="background-color: #ffffff"],
        .product-detail-color-circle.selected[data-color="Blanco"] {
            border-color: #ec4899 !important; /* Override with pink when selected */
        }


        @media (max-width: 768px) {
            .product-detail-modal-content {
                flex-direction: column; /* Stack vertically on small screens */
                max-height: 95vh;
                width: 95%;
            }
            .product-detail-image-section {
                height: 300px; /* Fixed height for image on small screens */
            }
            .product-detail-info-section {
                padding: 1rem;
            }
            .product-detail-info-section h3 {
                font-size: 1.5rem;
            }
            .product-detail-info-section .price-display {
                font-size: 1.25rem;
            }
            /* Adjust header nav for mobile */
            header .container {
                flex-direction: column;
                align-items: flex-end; /* Align nav to right */
            }
            header nav {
                width: auto; /* Let nav size itself */
                margin-top: 0.5rem;
                align-items: flex-end; /* Align nav items to right */
            }
            header nav button, header nav span {
                width: auto; /* Let buttons size themselves */
                text-align: right;
                margin-bottom: 0.25rem;
            }
            .category-slider {
                flex-direction: column; /* Stack category buttons vertically on mobile */
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 0;
            }
            /* Adjust search/filter controls for mobile when moved to category slider */
            .category-slider #searchFilterControls {
                width: 100%; /* Take full width */
                justify-content: center; /* Center buttons on mobile */
                margin-top: 0.5rem;
            }
            .category-slider #searchFilterControls .p-3 {
                padding: 0.75rem; /* Smaller padding for mobile buttons */
            }
            .category-slider #expandedSearchContainer,
            .category-slider #expandedFilterContainer {
                width: 95%; /* Adjust width for mobile modals */
                max-width: none;
                left: 2.5%; /* Center them */
                right: 2.5%;
            }
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .nav-active {
            border-bottom: 2px solid #ec4899; /* Pink border for active nav */
            color: #ec4899;
        }
        .btn-primary {
            background-color: #ec4899; /* Pink */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #db2777; /* Darker Pink */
        }
        .btn-secondary {
            background-color: #d1d5db; /* Gray */
            color: #1f2937; /* Dark Gray text */
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #9ca3af; /* Darker Gray */
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        /* Style for password input with eye icon */
        .password-input-container {
            position: relative;
            margin-bottom: 1rem;
        }
        .password-input-container .form-input {
            margin-bottom: 0; /* Remove default margin */
        }
        .password-toggle-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #9ca3af;
        }
        .password-toggle-icon:hover {
            color: #4b5563;
        }

        .product-card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
            cursor: pointer; /* Add pointer cursor for clickability */
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .product-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .product-card-content {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .product-card-actions {
            margin-top: auto; /* Pushes actions to the bottom */
        }
        .favorite-btn.active {
            color: #ec4899; /* Pink when active */
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #ec4899;
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }
        .gemini-loading-spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border-left-color: #ec4899;
            animation: spin 1s ease infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .accessory-item {
            background-color: #e5e7eb;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .accessory-item button {
            margin-left: 0.5rem;
            color: #ef4444; /* red-500 */
            background: none;
            border: none;
            cursor: pointer;
        }
        .discount-badge {
            background-color: #fca5a5; /* Red-300 */
            color: #b91c1c; /* Red-700 */
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-left: 0.5rem;
            display: inline-block; /* Ensure it takes up space correctly */
        }
        /* Floating WhatsApp Button */
        .whatsapp-float {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #25D366; /* WhatsApp green */
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 999;
            transition: transform 0.3s ease-in-out;
        }
        .whatsapp-float:hover {
            transform: scale(1.1);
        }
        /* Admin Section Layout */
        #adminSection {
            display: flex;
            flex-direction: column;
            gap: 2rem; /* Space between different admin forms */
        }
        #adminSection > div {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        /* Product Management List in Admin */
        .admin-product-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .admin-product-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            background-color: #f9fafb;
        }
        .admin-product-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 0.25rem;
            margin-right: 1rem;
        }
        .admin-product-item-info {
            flex-grow: 1;
        }
        .admin-product-item-info h4 {
            font-weight: 600;
            color: #374151;
        }
        .admin-product-item-info p {
            font-size: 0.875rem;
            color: #6b7280;
        }
        .admin-product-item button {
            background-color: #ef4444; /* Red */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .admin-product-item button:hover {
            background-color: #dc2626; /* Darker Red */
        }

        /* Styles for collapsible sections in Admin */
        .admin-section-container {
            background-color: white;
            padding: 0; /* Remove padding from container itself */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden; /* Ensures rounded corners apply to content */
        }

        .admin-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem; /* Padding for the header */
            background-color: #f3f4f6; /* Light gray background for header */
            cursor: pointer;
            font-size: 1.25rem;
            font-weight: 600;
            color: #ec4899; /* Pink */
            border-bottom: 1px solid #e5e7eb; /* Separator */
            transition: background-color 0.2s ease-in-out;
        }

        .admin-section-header:hover {
            background-color: #e5e7eb; /* Darker gray on hover */
        }

        .admin-section-header .icon {
            transition: transform 0.3s ease-in-out;
        }

        .admin-section-header.collapsed .icon {
            transform: rotate(-90deg); /* Rotate icon when collapsed */
        }

        .admin-section-content {
            padding: 2rem; /* Padding for the content inside */
            display: none; /* Hidden by default */
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
        }

        .admin-section-content.expanded {
            display: block; /* Show when expanded */
            max-height: 1000px; /* Arbitrarily large value for smooth transition */
            opacity: 1;
        }

        /* Header background styles */
        #mainHeader.bg-image {
            background-image: var(--header-bg-image);
            background-size: cover;
            background-position: var(--header-bg-position-x) var(--header-bg-position-y); /* Use CSS variables for position */
            background-repeat: no-repeat;
        }
        /* Only apply grab cursor when in editing mode */
        #mainHeader.bg-image.editing-mode {
            cursor: grab; /* Indicate draggable */
        }
        #mainHeader.bg-image.dragging {
            cursor: grabbing; /* Indicate actively dragging */
        }

        /* Responsive adjustments for header navigation */
        @media (max-width: 768px) {
            .container.flex-wrap {
                flex-direction: column;
                align-items: center;
            }
            nav.space-x-4 {
                display: flex;
                flex-direction: column;
                width: 100%;
                margin-top: 1rem;
                align-items: center;
            }
            nav button, nav span {
                width: 100%;
                text-align: center;
                margin-bottom: 0.5rem;
            }
            .category-slider {
                flex-direction: column; /* Stack category buttons vertically on mobile */
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 0;
            }
            /* Adjust search/filter controls for mobile when moved to category slider */
            .category-slider #searchFilterControls {
                width: 100%; /* Take full width */
                justify-content: center; /* Center buttons on mobile */
                margin-top: 0.5rem;
            }
            .category-slider #searchFilterControls .p-3 {
                padding: 0.75rem; /* Smaller padding for mobile buttons */
            }
            .category-slider #expandedSearchContainer,
            .category-slider #expandedFilterContainer {
                position: static; /* Remove absolute positioning on small screens */
                margin-top: 1rem;
                width: 100%;
                max-width: none;
            }
            .product-detail-modal-content {
                flex-direction: column; /* Stack image and info vertically */
            }
            .product-detail-image-section {
                height: 250px; /* Adjust height for mobile images */
            }
            .product-detail-info-section {
                padding: 1rem; /* Smaller padding on mobile */
            }
            .product-detail-info-section h3 {
                font-size: 1.25rem; /* Smaller font for title */
            }
            .product-detail-info-section .price-display {
                font-size: 1.1rem; /* Smaller font for price */
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <header id="mainHeader" class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex flex-wrap justify-end items-center">
            <nav class="space-x-4 mt-4 md:mt-0">
                <button id="favoritesBtn" class="hover:text-pink-500 px-3 py-2 rounded-md relative">
                    <i class="fas fa-heart"></i> Favoritos
                    <span id="favoritesCount" class="absolute top-0 right-0 bg-pink-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center" style="display: none;">0</span>
                </button>
                <button id="cartBtn" class="hover:text-pink-500 px-3 py-2 rounded-md relative">
                    <i class="fas fa-shopping-cart"></i> Carrito
                    <span id="cartCount" class="absolute top-0 right-0 bg-pink-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center" style="display: none;">0</span>
                </button>
                <span id="authLinks">
                    <button id="loginNavBtn" class="hover:text-pink-500 px-3 py-2 rounded-md">Iniciar Sesión</button>
                    <button id="registerNavBtn" class="btn-primary text-sm">Registrarse</button>
                </span>
                <span id="userProfileLink" style="display:none;">
                    <button id="profileNavBtn" class="hover:text-pink-500 px-3 py-2 rounded-md"><i class="fas fa-user"></i> Perfil</button>
                    <button id="adminNavBtn" class="hover:text-pink-500 px-3 py-2 rounded-md" style="display:none;"><i class="fas fa-cogs"></i> Admin</button>
                    <button id="logoutBtn" class="btn-secondary text-sm">Cerrar Sesión</button>
                </span>
            </nav>
        </div>
    </header>

    <div class="category-slider bg-white shadow-sm py-2 px-4 flex flex-wrap justify-between items-center sticky top-16 z-40">
        <div class="flex gap-4 mb-2 md:mb-0">
            <button id="boutiqueBtn" data-category="Boutique" class="category-btn hover:text-pink-500 px-3 py-2 rounded-md flex items-center">
                <i class="fas fa-shirt mr-2"></i> Boutique
            </button>
            <button id="makeupBtn" data-category="Make Up" class="category-btn hover:text-pink-500 px-3 py-2 rounded-md flex items-center">
                <i class="fas fa-lipstick mr-2"></i> Make Up
            </button>
        </div>
        
        <div id="searchFilterControls" class="flex flex-row justify-end items-center gap-4 relative">
            <button id="searchIconBtn" class="p-3 rounded-full bg-pink-500 text-white shadow-lg hover:bg-pink-600 transition-colors duration-200 z-20">
                <i class="fas fa-search text-lg"></i>
            </button>
            <button id="filterIconBtn" class="p-3 rounded-full bg-pink-500 text-white shadow-lg hover:bg-pink-600 transition-colors duration-200 z-20">
                <i class="fas fa-sliders text-lg"></i>
            </button>

            <div id="expandedSearchContainer" class="absolute right-0 top-full mt-2 bg-white p-4 rounded-lg shadow-xl z-10 w-full max-w-sm" style="display: none;">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Buscar productos..." class="form-input pl-10 pr-4 py-2 rounded-full border-gray-300 focus:ring-pink-500 focus:border-pink-500 w-full">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <button id="closeSearchBtn" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-800 text-xl">&times;</button>
                </div>
            </div>

            <div id="expandedFilterContainer" class="absolute right-0 top-full mt-2 bg-white p-4 rounded-lg shadow-xl z-10 w-full max-w-sm" style="display: none;">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-semibold text-gray-700">Filtros de Búsqueda</h4>
                    <button id="closeFilterBtn" class="text-gray-500 hover:text-gray-800 text-xl">&times;</button>
                </div>
                <select id="categoryFilter" class="form-input py-2 px-4 rounded-md border-gray-300 focus:ring-pink-500 focus:border-pink-500 mb-2">
                    <option value="All">Todas las Categorías</option>
                    <option value="Boutique">Boutique</option>
                    <option value="Make Up">Make Up</option>
                </select>
                <input type="number" id="minPriceInput" placeholder="Precio Mín." class="form-input py-2 px-4 rounded-md border-gray-300 focus:ring-pink-500 focus:border-pink-500 mb-2">
                <input type="number" id="maxPriceInput" placeholder="Precio Máx." class="form-input py-2 px-4 rounded-md border-gray-300 focus:ring-pink-500 focus:border-pink-500 mb-4">
                <div class="flex gap-2">
                    <button id="applyFiltersBtn" class="btn-primary py-2 px-4 text-sm flex-grow">Aplicar</button>
                    <button id="clearFiltersBtn" class="btn-secondary py-2 px-4 text-sm flex-grow">Limpiar</button>
                </div>
            </div>
        </div>
    </div>

    <main class="container mx-auto px-4 py-8">
        <div id="loadingIndicator" class="loading-spinner" style="display: none;"></div>
        
        <div id="pageContent">
            <div id="productGridContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                </div>
        </div>

        <div id="favoritesSection" style="display:none;">
            <h2 class="text-3xl font-bold text-pink-500 mb-6">Mis Favoritos</h2>
            <div id="favoritesContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
        </div>

        <div id="cartSection" style="display:none;">
            <h2 class="text-3xl font-bold text-pink-500 mb-6">Mi Carrito</h2>
            <div id="cartItemsContainer" class="bg-white p-6 rounded-lg shadow-xl"></div>
            <button id="checkoutBtn" class="btn-primary mt-6 w-full md:w-auto">Proceder al Pago</button>
        </div>

        <div id="loginSection" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-xl" style="display:none;">
            <h2 class="text-2xl font-semibold text-center mb-6 text-pink-500">Iniciar Sesión</h2>
            <form id="loginForm">
                <input type="email" id="loginEmail" placeholder="Correo Electrónico" class="form-input" required>
                <div class="password-input-container">
                    <input type="password" id="loginPassword" placeholder="Contraseña" class="form-input" required>
                    <i class="fas fa-eye password-toggle-icon" data-target="loginPassword"></i>
                </div>
                <button type="submit" class="btn-primary w-full">Iniciar Sesión</button>
            </form>
            <p class="text-center mt-4">
                <a href="#" id="forgotPasswordLink" class="text-sm text-pink-500 hover:underline">¿Olvidaste tu contraseña?</a>
            </p>
            <p class="text-center mt-2">
                ¿No tienes cuenta? <a href="#" id="showRegisterFromLogin" class="text-pink-500 hover:underline">Regístrate aquí</a>
            </p>
        </div>

        <div id="registerSection" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-xl" style="display:none;">
            <h2 class="text-2xl font-semibold text-center mb-6 text-pink-500">Crear Cuenta</h2>
            <form id="registerForm">
                <input type="text" id="registerFullName" placeholder="Nombres y Apellidos" class="form-input" required>
                <input type="email" id="registerEmail" placeholder="Correo Electrónico" class="form-input" required>
                <input type="tel" id="registerPhone" placeholder="Número de Teléfono" class="form-input" required>
                <input type="text" id="registerAddress" placeholder="Dirección de Domicilio" class="form-input" required>
                <div class="password-input-container">
                    <input type="password" id="registerPassword" placeholder="Contraseña" class="form-input" required>
                    <i class="fas fa-eye password-toggle-icon" data-target="registerPassword"></i>
                </div>
                <div class="password-input-container">
                    <input type="password" id="registerConfirmPassword" placeholder="Confirmar Contraseña" class="form-input" required>
                    <i class="fas fa-eye password-toggle-icon" data-target="registerConfirmPassword"></i>
                </div>
                <button type="submit" class="btn-primary w-full">Registrarse</button>
            </form>
            <p class="text-center mt-4">
                ¿Ya tienes cuenta? <a href="#" id="showLoginFromRegister" class="text-pink-500 hover:underline">Inicia sesión aquí</a>
            </p>
        </div>

        <div id="forgotPasswordSection" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-xl" style="display:none;">
            <h2 class="text-2xl font-semibold text-center mb-6 text-pink-500">Recuperar Contraseña</h2>
            <form id="forgotPasswordForm">
                <input type="email" id="forgotPasswordEmail" placeholder="Correo Electrónico" class="form-input" required>
                <button type="submit" class="btn-primary w-full">Enviar Enlace de Recuperación</button>
            </form>
            <p class="text-center mt-4">
                <a href="#" id="backToLoginFromForgot" class="text-pink-500 hover:underline">Volver a Iniciar Sesión</a>
            </p>
        </div>
        
        <div id="profileSection" class="max-w-lg mx-auto bg-white p-8 rounded-lg shadow-xl" style="display:none;">
            <h2 class="text-2xl font-semibold mb-6 text-pink-500">Mi Perfil</h2>
            <form id="profileForm">
                <div class="mb-4">
                    <label for="profileFullName" class="block text-sm font-medium text-gray-700">Nombres y Apellidos</label>
                    <input type="text" id="profileFullName" class="form-input mt-1" required>
                </div>
                <div class="mb-4">
                    <label for="profileEmail" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                    <input type="email" id="profileEmail" class="form-input mt-1" readonly disabled>
                </div>
                <div class="mb-4">
                    <label for="profilePhone" class="block text-sm font-medium text-gray-700">Número de Teléfono</label>
                    <input type="tel" id="profilePhone" class="form-input mt-1" required>
                </div>
                <div class="mb-4">
                    <label for="profileAddress" class="block text-sm font-medium text-gray-700">Dirección de Domicilio</label>
                    <input type="text" id="profileAddress" class="form-input mt-1" required>
                </div>
                <button type="submit" class="btn-primary w-full mt-4">Actualizar Perfil</button>
            </form>
             <p class="text-sm text-gray-600 mt-2">UserID: <span id="profileUserId"></span></p>
        </div>

        <div id="adminSection" class="max-w-xl mx-auto" style="display:none;">
            <h2 class="text-2xl font-semibold mb-6 text-pink-500 text-center">Panel de Administrador</h2>
            
            <div class="admin-section-container">
                <div class="admin-section-header" data-target="adminCredentialsContent">
                    <h3>Administrar Credenciales de Admin</h3>
                    <i class="fas fa-chevron-down icon"></i>
                </div>
                <div id="adminCredentialsContent" class="admin-section-content">
                    <form id="adminCredentialsForm">
                        <div class="password-input-container">
                            <label for="adminCurrentPassword" class="block text-sm font-medium text-gray-700">Contraseña Actual de Admin</label>
                            <input type="password" id="adminCurrentPassword" class="form-input mt-1" required>
                            <i class="fas fa-eye password-toggle-icon" data-target="adminCurrentPassword"></i>
                        </div>
                        <div class="mb-4">
                            <label for="adminNewUsername" class="block text-sm font-medium text-gray-700">Nuevo Nombre de Usuario (Email)</label>
                            <input type="email" id="adminNewUsername" class="form-input mt-1">
                        </div>
                        <div class="password-input-container">
                            <label for="adminNewPassword" class="block text-sm font-medium text-gray-700">Nueva Contraseña</label>
                            <input type="password" id="adminNewPassword" class="form-input mt-1">
                            <i class="fas fa-eye password-toggle-icon" data-target="adminNewPassword"></i>
                        </div>
                        <div class="password-input-container">
                            <label for="adminConfirmNewPassword" class="block text-sm font-medium text-gray-700">Confirmar Nueva Contraseña</label>
                            <input type="password" id="adminConfirmNewPassword" class="form-input mt-1">
                            <i class="fas fa-eye password-toggle-icon" data-target="adminConfirmNewPassword"></i>
                        </div>
                        <button type="submit" class="btn-primary w-full">Actualizar Credenciales de Admin</button>
                    </form>
                </div>
            </div>

            <div class="admin-section-container">
                <div class="admin-section-header" data-target="socialMediaContent">
                    <h3>Configurar Redes Sociales</h3>
                    <i class="fas fa-chevron-down icon"></i>
                </div>
                <div id="socialMediaContent" class="admin-section-content">
                    <form id="socialMediaForm">
                        <div class="mb-4">
                            <label for="socialFacebook" class="block text-sm font-medium text-gray-700">Facebook URL</label>
                            <input type="url" id="socialFacebook" placeholder="https://facebook.com/divinemuse" class="form-input mt-1">
                        </div>
                        <div class="mb-4">
                            <label for="socialInstagram" class="block text-sm font-medium text-gray-700">Instagram URL</label>
                            <input type="url" id="socialInstagram" placeholder="https://instagram.com/divinemuse" class="form-input mt-1">
                        </div>
                        <div class="mb-4">
                            <label for="socialTwitter" class="block text-sm font-medium text-gray-700">Twitter URL</label>
                            <input type="url" id="socialTwitter" placeholder="https://twitter.com/divinemuse" class="form-input mt-1">
                        </div>
                        <div class="mb-4">
                            <label for="socialTiktok" class="block text-sm font-medium text-gray-700">TikTok URL</label>
                            <input type="url" id="socialTiktok" placeholder="https://tiktok.com/@divinemuse" class="form-input mt-1">
                        </div>
                        <div class="mb-4">
                            <label for="socialWhatsapp" class="block text-sm font-medium text-gray-700">WhatsApp URL</label>
                            <input type="url" id="socialWhatsapp" placeholder="https://wa.me/1234567890" class="form-input mt-1">
                        </div>
                        <button type="submit" class="btn-primary w-full">Guardar Redes Sociales</button>
                    </form>
                </div>
            </div>

            <div class="admin-section-container">
                <div class="admin-section-header" data-target="discountContent">
                    <h3>Configuración de Descuentos</h3>
                    <i class="fas fa-chevron-down icon"></i>
                </div>
                <div id="discountContent" class="admin-section-content">
                    <form id="discountForm">
                        <div class="mb-4">
                            <label for="globalDiscount" class="block text-sm font-medium text-gray-700">Porcentaje de Descuento Global (%)</label>
                            <input type="number" id="globalDiscount" min="0" max="100" step="1" placeholder="Ej: 10" class="form-input mt-1" required>
                        </div>
                        <button type="submit" class="btn-primary w-full">Guardar Descuento</button>
                    </form>
                    <p class="text-sm text-gray-600 mt-2">Descuento Actual: <span id="currentDiscountDisplay">0%</span></p>
                </div>
            </div>

            <div class="admin-section-container">
                <div class="admin-section-header" data-target="missionVisionContent">
                    <h3>Misión y Visión de la Tienda</h3>
                    <i class="fas fa-chevron-down icon"></i>
                </div>
                <div id="missionVisionContent" class="admin-section-content">
                    <form id="missionVisionForm">
                        <div class="mb-4">
                            <label for="missionVisionTextarea" class="block text-sm font-medium text-gray-700">Texto de Misión y Visión</label>
                            <textarea id="missionVisionTextarea" placeholder="Escribe aquí la misión y visión de tu tienda..." class="form-input h-32 mt-1"></textarea>
                        </div>
                        <button type="submit" class="btn-primary w-full">Guardar Misión y Visión</button>
                    </form>
                </div>
            </div>

            <div class="admin-section-container">
                <div class="admin-section-header" data-target="headerBackgroundContent">
                    <h3>Configuración de Fondo de la Cabecera</h3>
                    <i class="fas fa-chevron-down icon"></i>
                </div>
                <div id="headerBackgroundContent" class="admin-section-content">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Fondo:</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="headerBackgroundType" value="color" id="headerBgColorRadio" class="form-radio text-pink-500" checked>
                                <span class="ml-2">Color</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="headerBackgroundType" value="image" id="headerBgImageRadio" class="form-radio text-pink-500">
                                <span class="ml-2">Imagen</span>
                            </label>
                        </div>
                    </div>

                    <div id="headerBgColorOptions" class="mb-4">
                        <label for="headerBgColor" class="block text-sm font-medium text-gray-700">Seleccionar Color de Fondo</label>
                        <input type="color" id="headerBgColor" class="w-full h-12 p-0 border-none cursor-pointer rounded-md overflow-hidden mt-1">
                    </div>

                    <div id="headerBgImageOptions" class="mb-4" style="display:none;">
                        <label for="headerBgImageUpload" class="block text-sm font-medium text-gray-700">Subir Imagen de Fondo</label>
                        <input type="file" id="headerBgImageUpload" accept="image/*" class="form-input mt-1 p-2 border rounded-md">
                        <div id="headerBgImagePreview" class="mt-2 text-sm text-gray-500"></div>
                        <p class="text-xs text-gray-500 mt-2">Haz clic en "Vista Previa" para arrastrar y ajustar la imagen.</p>
                    </div>
                    
                    <div class="flex gap-2 mt-4">
                        <button type="button" id="previewHeaderBgBtn" class="btn-secondary w-full">Vista Previa</button>
                        <button type="button" id="saveHeaderBgBtn" class="btn-primary w-full">Guardar Cambios</button>
                    </div>
                </div>
            </div>

            <div class="admin-section-container">
                <div class="admin-section-header" data-target="addProductContent">
                    <h3>Añadir Nuevo Producto</h3>
                    <i class="fas fa-chevron-down icon"></i>
                </div>
                <div id="addProductContent" class="admin-section-content">
                    <form id="addProductForm">
                        <div class="mb-4">
                            <label for="productName" class="block text-sm font-medium text-gray-700">Nombre del Producto</label>
                            <input type="text" id="productName" placeholder="Nombre del Producto" class="form-input mt-1" required>
                        </div>
                        
                        <div class="mb-4">
                            <label for="productDescription" class="block text-sm font-medium text-gray-700">Descripción del Producto</label>
                            <textarea id="productDescription" placeholder="Descripción base del producto" class="form-input h-24 mt-1" required></textarea>
                            <button type="button" id="generateDescBtn" class="btn-secondary text-sm py-2 px-3 mt-2">
                                ✨ Generar Descripción Mejorada <span id="descLoadingSpinner" class="gemini-loading-spinner" style="display: none;"></span>
                            </button>
                        </div>

                        <div class="mb-4">
                            <label for="productPrice" class="block text-sm font-medium text-gray-700">Precio (ej: 29.99)</label>
                            <input type="number" id="productPrice" placeholder="Precio (ej: 29.99)" step="0.01" class="form-input mt-1" required>
                        </div>

                        <div class="mb-4">
                            <label for="productStock" class="block text-sm font-medium text-gray-700">Stock Disponible</label>
                            <input type="number" id="productStock" min="0" step="1" value="1" class="form-input mt-1" required>
                        </div>

                        <div class="mb-4">
                            <label for="productIndividualDiscount" class="block text-sm font-medium text-gray-700">Descuento Individual del Producto (%)</label>
                            <input type="number" id="productIndividualDiscount" min="0" max="100" step="1" value="0" class="form-input mt-1">
                            <p class="text-xs text-gray-500 mt-1">Este descuento se aplica solo a este producto, anulando el descuento global si es mayor.</p>
                        </div>

                        <div class="mb-4">
                            <label for="productCategory" class="block text-sm font-medium text-gray-700">Categoría</label>
                            <select id="productCategory" class="form-input mt-1" required>
                                <option value="" disabled selected>Seleccionar Categoría</option>
                                <option value="Boutique">Boutique</option>
                                <option value="Make Up">Make Up</option>
                            </select>
                        </div>

                        <div id="productSizesContainer" class="mb-4" style="display: none;">
                            <h4 class="text-lg font-medium mt-6 mb-2">Tallas Disponibles</h4>
                            <div class="flex items-center mb-2">
                                <select id="sizeSelector" class="form-input mr-2 flex-grow">
                                    <option value="" disabled selected>Seleccionar Talla</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                </select>
                                <button type="button" id="addSizeBtn" class="btn-secondary py-2 px-3 text-sm whitespace-nowrap">Añadir Talla</button>
                            </div>
                            <div id="addedSizesList" class="space-y-1 mb-4 bg-gray-50 p-2 rounded-md min-h-[40px]">
                                <p id="noSizesText" class="text-sm text-gray-500">No se han añadido tallas.</p>
                            </div>
                        </div>

                        <div id="productColorsAndImagesContainer" class="mb-4">
                            <h4 class="text-lg font-medium mt-6 mb-2">Colores y sus Imágenes</h4>
                            <div class="flex flex-col sm:flex-row items-center mb-2 gap-2">
                                <input type="text" id="colorNameInput" placeholder="Nombre del Color (ej: Rojo, #FF0000)" class="form-input flex-grow">
                                <input type="color" id="colorPickerInput" class="w-full sm:w-12 h-12 p-0 border-none cursor-pointer rounded-md overflow-hidden">
                                <input type="file" id="colorImageUploadInput" accept="image/*" multiple class="hidden">
                                <button type="button" id="selectColorImagesBtn" class="btn-secondary py-2 px-3 text-sm whitespace-nowrap w-full sm:w-auto">Seleccionar Imágenes</button>
                                <button type="button" id="addColorsAndImagesBtn" class="btn-primary py-2 px-3 text-sm whitespace-nowrap w-full sm:w-auto">Añadir Color</button>
                            </div>
                            <div id="colorImagePreviewContainer" class="mt-2 flex flex-wrap gap-2">
                                <p id="noColorImagesText" class="text-sm text-gray-500">No se han seleccionado imágenes para este color.</p>
                            </div>
                            <div id="addedColorsAndImagesList" class="space-y-2 mt-4 bg-gray-50 p-3 rounded-md min-h-[60px]">
                                <p id="noColorsAddedText" class="text-sm text-gray-500">No se han añadido colores.</p>
                            </div>
                        </div>
                        
                        <div class="mb-4" style="display: none;"> <label for="productImageUpload" class="block text-sm font-medium text-gray-700">Subir Imágenes (seleccionar una o varias)</label>
                            <input type="file" id="productImageUpload" accept="image/*" multiple class="form-input mt-1 p-2 border rounded-md">
                            <div id="imagePreviewContainer" class="mt-2 flex flex-wrap gap-2"></div>
                        </div>

                        <h4 class="text-lg font-medium mt-6 mb-2">Accesorios del Producto</h4>
                        <div class="flex flex-col sm:flex-row items-center mb-2 gap-2">
                            <input type="text" id="accessoryName" placeholder="Nombre del Accesorio" class="form-input flex-grow">
                            <button type="button" id="addAccessoryBtn" class="btn-secondary py-2 px-3 text-sm whitespace-nowrap w-full sm:w-auto">Añadir Accesorio</button>
                        </div>
                        <div id="accessoriesListContainer" class="space-y-1 mb-4 bg-gray-50 p-2 rounded-md min-h-[40px]">
                            <p id="noAccessoriesText" class="text-sm text-gray-500">No se han añadido accesorios.</p>
                        </div>
                        
                        <button type="submit" class="btn-primary w-full mt-6">Añadir Producto</button>
                    </form>
                </div>
            </div>

            <div class="admin-section-container">
                <div class="admin-section-header" data-target="manageProductsContent">
                    <h3>Gestionar Productos Existentes</h3>
                    <i class="fas fa-chevron-down icon"></i>
                </div>
                <div id="manageProductsContent" class="admin-section-content">
                    <div id="adminProductList" class="admin-product-list">
                        <p class="text-gray-500 text-center">Cargando productos...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <div id="missionVisionDisplay" class="mb-8 p-4 bg-gray-700 rounded-lg">
                <h3 class="text-xl font-semibold text-pink-400 mb-2">Nuestra Misión y Visión</h3>
                <p id="missionVisionText" class="text-gray-300 leading-relaxed">Cargando misión y visión...</p>
            </div>
            <p class="mb-4">Síguenos en nuestras redes sociales:</p>
            <div class="space-x-4 mb-4" id="socialMediaIcons">
                <a href="#" id="facebookLink" class="hover:text-pink-400" target="_blank"><i class="fab fa-facebook-f fa-2x"></i></a>
                <a href="#" id="instagramLink" class="hover:text-pink-400" target="_blank"><i class="fab fa-instagram fa-2x"></i></a>
                <a href="#" id="twitterLink" class="hover:text-pink-400" target="_blank"><i class="fab fa-twitter fa-2x"></i></a>
                <a href="#" id="tiktokLink" class="hover:text-pink-400" target="_blank"><i class="fab fa-tiktok fa-2x"></i></a>
            </div>
            <p>&copy; <span id="currentYear"></span> Divine Muse. Todos los derechos reservados.</p>
            <p class="text-xs mt-2">App ID: <span id="appIdDisplay"></span></p>
        </div>
    </footer>

    <a href="#" id="whatsappFloatBtn" class="whatsapp-float" target="_blank" style="display: none;">
        <i class="fab fa-whatsapp"></i>
    </a>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeModalBtn">&times;</span>
            <p id="modalMessageText"></p>
        </div>
    </div>

    <div id="productDetailModal" class="product-detail-modal">
        <div class="product-detail-modal-content">
            <button class="close-button absolute top-2 right-4 text-3xl z-10" id="closeProductDetailModal">&times;</button>
            <div class="product-detail-image-section">
                <img id="productDetailImage" src="" alt="Product Image" class="product-detail-image">
                <div class="product-detail-image-nav">
                    <button id="prevImageBtn"><i class="fas fa-chevron-left"></i></button>
                    <button id="nextImageBtn"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="product-detail-dots" id="productDetailDots">
                    </div>
            </div>
            <div class="product-detail-info-section">
                <h3 id="productDetailName"></h3>
                <div class="price-display">
                    <span id="productDetailOriginalPrice" class="original-price"></span>
                    <span id="productDetailDiscountedPrice" class="discounted-price"></span>
                </div>
                <p id="productDetailDescription"></p>
                <div class="product-detail-options" id="productDetailSizes">
                    <h4>Tallas:</h4>
                    <div id="productDetailSizesList" class="flex flex-wrap gap-2">
                        </div>
                </div>
                <div class="product-detail-options" id="productDetailColors">
                    <h4>Colores:</h4>
                    <div id="productDetailColorsList" class="flex flex-wrap gap-2">
                        </div>
                </div>
                <div class="product-detail-accessories">
                    <h4>Accesorios:</h4>
                    <div id="productDetailAccessoriesList" class="product-detail-accessories-list flex flex-wrap gap-2">
                        </div>
                </div>
                <button class="btn-primary w-full mt-auto" id="productDetailAddToCartBtn">Añadir al Carrito</button>
                <p id="productDetailStock" class="text-sm font-semibold mt-2 text-gray-700"></p>
            </div>
        </div>
    </div>

    <script type="module">
        // --- MOCK DATA (Simulando una base de datos en memoria) ---
        let mockUsers = {
            'admin@example.com': { // Admin user for testing
                uid: 'mock-admin-user-123',
                email: 'admin@example.com',
                password: 'password123', // In a real app, this would be hashed!
                isAnonymous: false,
                isAdmin: true, // New property for admin role
                profile: {
                    name: 'Admin User',
                    phone: '123456789',
                    address: 'Calle Admin 123',
                    createdAt: new Date().toISOString()
                }
            }
        }; 
        let mockProducts = [
            { id: 'prod1', name: 'Vestido de Noche Elegante', description: 'Un vestido espectacular para ocasiones especiales, con un diseño único y tela de seda.', price: 120.00, category: 'Boutique', imageSets: [{ color: 'Rojo', urls: ['https://via.placeholder.com/400x300/FF0000/FFFFFF?text=Vestido+Rojo+1', 'https://via.placeholder.com/400x300/FF0000/FFFFFF?text=Vestido+Rojo+2'] }, { color: 'Azul', urls: ['https://via.placeholder.com/400x300/0000FF/FFFFFF?text=Vestido+Azul+1'] }], accessories: ['Cinturón a juego', 'Collar de perlas'], sizes: ['S', 'M', 'L'], discountPercentage: 15, stock: 5 },
            { id: 'prod2', name: 'Kit de Maquillaje Profesional', description: 'Set completo con sombras, labiales y brochas de alta calidad para un look perfecto.', price: 75.50, category: 'Make Up', imageSets: [{ color: 'Default', urls: ['https://via.placeholder.com/400x300?text=Maquillaje+Pro+1', 'https://via.placeholder.com/400x300?text=Maquillaje+Pro+2'] }], accessories: ['Estuche de viaje', 'Espejo LED'], sizes: [], discountPercentage: 0, stock: 10 },
            { id: 'prod3', name: 'Blusa de Verano Floral', description: 'Blusa ligera y fresca con estampado floral, ideal para el día a día.', price: 35.00, category: 'Boutique', imageSets: [{ color: 'Verde', urls: ['https://via.placeholder.com/400x300/00FF00/000000?text=Blusa+Verde+1'] }], accessories: [], sizes: ['XS', 'S'], discountPercentage: 10, stock: 0 }, // Out of stock example
            { id: 'prod4', name: 'Set de Labiales Mate', description: 'Colección de labiales de larga duración con acabado mate en tonos variados.', price: 45.00, category: 'Make Up', imageSets: [{ color: 'Default', urls: ['https://via.placeholder.com/400x300?text=Labiales+Mate+1', 'https://via.placeholder.com/400x300?text=Labiales+Mate+2'] }], accessories: ['Delineador a juego'], sizes: [], discountPercentage: 0, stock: 8 },
            { id: 'prod5', name: 'Falda Midi Plisada', description: 'Falda elegante con pliegues, perfecta para un estilo casual o formal.', price: 55.00, category: 'Boutique', imageSets: [{ color: 'Negro', urls: ['https://via.placeholder.com/400x300/000000/FFFFFF?text=Falda+Negra+1'] }, { color: 'Blanco', urls: ['https://via.placeholder.com/400x300/FFFFFF/000000?text=Falda+Blanca+1'] }], accessories: [], sizes: ['M', 'L', 'XL'], discountPercentage: 20, stock: 3 },
            { id: 'prod6', name: 'Paleta de Sombras Neutras', description: 'Paleta versátil con 12 tonos neutros para looks naturales o ahumados.', price: 30.00, category: 'Make Up', imageSets: [{ color: 'Default', urls: ['https://via.placeholder.com/400x300?text=Sombras+Neutras+1'] }], accessories: [], sizes: [], discountPercentage: 0, stock: 12 },
        ];
        let mockUserFavorites = {}; // Key: userId, Value: Array of productIds
        let mockUserCarts = {}; // Key: userId, Value: Array of { productId, quantity, selectedSize, selectedColor }
        let mockAppConfig = { // New mock config for global settings and social media
            globalDiscount: 0, // Initial discount percentage
            socialMediaLinks: {
                facebook: 'https://www.facebook.com/DivineMuseStore',
                instagram: 'https://www.instagram.com/divinemuse_official/',
                twitter: 'https://x.com/DivineMuse_Es',
                tiktok: 'https://www.tiktok.com/@divinemuse.shop',
                whatsapp: 'https://wa.me/1234567890' // Default WhatsApp URL
            },
            missionVisionText: 'Nuestra misión es empoderar a cada mujer, ofreciendo productos de belleza y moda que realcen su confianza y estilo único. Nos esforzamos por la excelencia en calidad y servicio, creando una experiencia de compra inspiradora y personalizada.',
            headerBackground: { // New: Header background settings
                type: 'color', // 'color' or 'image'
                value: '#f9fafb', // Hex color or image URL
                positionX: 50, // Default center percentage (0-100)
                positionY: 50  // Default center percentage (0-100)
            }
        };

        // Simulamos un ID de App (ya que no viene de Firebase)
        const effectiveAppId = 'mock-divine-muse-app-id';
        document.getElementById('appIdDisplay').textContent = effectiveAppId;

        // --- MOCK SERVICES (Imitando la API de Firebase) ---

        class AuthService {
            constructor() {
                this._currentUser = null;
                this._authListeners = [];
                this._initializeAuth();
            }

            _initializeAuth() {
                // Try to load a "session" from localStorage
                const storedUser = localStorage.getItem('mockCurrentUser');
                if (storedUser) {
                    this._setCurrentUser(JSON.parse(storedUser));
                } else {
                    this._setCurrentUser({ uid: 'mock-anonymous-user', isAnonymous: true, email: null, isAdmin: false });
                }
            }

            _setCurrentUser(user) {
                this._currentUser = user;
                localStorage.setItem('mockCurrentUser', JSON.stringify(user));
                this._authListeners.forEach(callback => callback(user));
            }

            async createUserWithEmailAndPassword(email, password) {
                if (mockUsers[email]) {
                    throw new Error("auth/email-already-in-use");
                }
                const uid = `mock-user-${Date.now()}`;
                const newUser = {
                    uid: uid,
                    email: email,
                    password: password, // In a real app, this would be hashed!
                    isAnonymous: false,
                    isAdmin: false,
                    profile: {
                        name: '',
                        phone: '',
                        address: '',
                        createdAt: new Date().toISOString()
                    }
                };
                mockUsers[email] = newUser;
                this._setCurrentUser(newUser);
                console.log("Mock User Registered:", newUser);
                return { user: { uid: newUser.uid, email: newUser.email, isAnonymous: newUser.isAnonymous, isAdmin: newUser.isAdmin } };
            }

            async signInWithEmailAndPassword(email, password) {
                const user = mockUsers[email];
                if (!user || user.password !== password) {
                    throw new Error("auth/invalid-credential");
                }
                this._setCurrentUser(user);
                console.log("Mock User Logged In:", user);
                return { user: { uid: user.uid, email: user.email, isAnonymous: user.isAnonymous, isAdmin: user.isAdmin } };
            }

            async signOut() {
                localStorage.removeItem('mockCurrentUser');
                this._setCurrentUser({ uid: 'mock-anonymous-user', isAnonymous: true, email: null, isAdmin: false });
                console.log("Mock User Signed Out.");
            }

            onAuthStateChanged(callback) {
                this._authListeners.push(callback);
                // Immediately call with current user state
                callback(this._currentUser);
                // Return an unsubscribe function (mocked)
                return () => {
                    this._authListeners = this._authListeners.filter(l => l !== callback);
                };
            }

            get currentUser() {
                return this._currentUser;
            }

            async sendPasswordResetEmail(email) {
                if (!mockUsers[email]) {
                    throw new Error("auth/user-not-found");
                }
                console.log(`Mock: Password reset email sent to ${email}`);
                return true;
            }

            // New: Mock method for updating user password (admin only)
            async updatePassword(oldPassword, newPassword) {
                if (!this._currentUser || !this._currentUser.isAdmin) {
                    throw new Error("auth/permission-denied");
                }
                const adminUser = mockUsers[this._currentUser.email];
                if (adminUser.password !== oldPassword) {
                    throw new Error("auth/wrong-password");
                }
                adminUser.password = newPassword; // In real app, re-hash!
                this._setCurrentUser({ ...adminUser }); // Trigger update
                console.log("Mock Admin Password Updated.");
                return true;
            }

            // New: Mock method for updating user email (admin only)
            async updateEmail(oldEmail, newEmail, password) {
                if (!this._currentUser || !this._currentUser.isAdmin) {
                    throw new Error("auth/permission-denied");
                }
                const adminUser = mockUsers[oldEmail];
                if (!adminUser || adminUser.password !== password) {
                    throw new Error("auth/invalid-credential");
                }
                if (mockUsers[newEmail] && newEmail !== oldEmail) {
                    throw new Error("auth/email-already-in-use");
                }
                
                // Update the user object
                const updatedUser = { ...adminUser, email: newEmail };
                delete mockUsers[oldEmail];
                mockUsers[newEmail] = updatedUser;
                this._setCurrentUser({ ...updatedUser }); // Trigger update
                console.log(`Mock Admin Email updated from ${oldEmail} to ${newEmail}`);
                return true;
            }
        }

        class FirestoreService {
            constructor() {
                this.db = {
                    products: mockProducts,
                    users: mockUsers, // Directly linked for simplicity
                    favorites: mockUserFavorites,
                    cart: mockUserCarts,
                    appConfig: mockAppConfig
                };
                this._listeners = {}; // To simulate onSnapshot
            }

            _generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            // Internal helper to notify listeners for a given path
            _notifyListeners(path) {
                console.log(`_notifyListeners called for path: ${path}`);
                if (this._listeners[path]) {
                    // For collection listeners, we pass a "snapshot" of all documents
                    if (path.includes('/')) { // Subcollection, e.g., users/uid/favorites
                        const parts = path.split('/');
                        const collectionName = parts[0];
                        const docId = parts[1];
                        const subCollectionName = parts[2];
                        const subDocId = parts[3]; // Could be undefined

                        if (collectionName === 'users' && subCollectionName === 'favorites') {
                            const favoriteIds = mockUserFavorites[docId] || [];
                            const docs = favoriteIds.map(id => ({ id: id, data: () => ({ productId: id }) }));
                            this._listeners[path].forEach(callback => callback({ docs }));
                        } else if (collectionName === 'users' && subCollectionName === 'cart') {
                            const cartItems = mockUserCarts[docId] || [];
                            const docs = cartItems.map(item => ({ id: item.productId, data: () => ({ ...item }) }));
                            this._listeners[path].forEach(callback => callback({ docs }));
                        } else if (collectionName === 'users' && subCollectionName === 'profile' && subDocId === 'data') {
                            const userEmail = Object.keys(mockUsers).find(email => mockUsers[email].uid === docId);
                            const userData = userEmail ? mockUsers[userEmail].profile : null;
                            if (userData) {
                                this._listeners[path].forEach(callback => callback({ exists: () => true, data: () => ({ ...userData }) }));
                            }
                        }
                    } else { // Top-level collection, e.g., products
                        const docs = this.db[path].map(item => ({ id: item.id, data: () => ({ ...item }) }));
                        this._listeners[path].forEach(callback => callback({ docs }));
                    }
                }
                // Also notify general app config if settings changed
                if (path === 'appConfig/settings' && this._listeners['appConfig/settings']) {
                     this._listeners['appConfig/settings'].forEach(callback => callback({ exists: () => true, data: () => ({ ...mockAppConfig }) }));
                }
                // If a product was updated, also trigger a general products listener
                if (path.startsWith('products/') && this._listeners['products']) {
                    this._listeners['products'].forEach(callback => callback({ docs: mockProducts.map(p => ({ id: p.id, data: () => ({ ...p }) })) }));
                }
            }

            async getDocs(collectionRef) {
                console.log("Mock Firestore: getDocs on", collectionRef);
                const [collectionName, userId, subCollectionName] = collectionRef.split('/');

                if (collectionName === 'products') {
                    return mockProducts.map(p => ({ id: p.id, data: () => ({ ...p }) }));
                } else if (collectionName === 'users' && userId && subCollectionName === 'favorites') {
                    const favoriteIds = mockUserFavorites[userId] || [];
                    return favoriteIds.map(id => ({ id: id, data: () => ({ productId: id }) }));
                } else if (collectionName === 'users' && userId && subCollectionName === 'cart') {
                    const cartItems = mockUserCarts[userId] || [];
                    return cartItems.map(item => ({ id: item.productId, data: () => ({ ...item }) }));
                }
                return [];
            }

            async getDoc(docPath) {
                console.log("Mock Firestore: getDoc on", docPath);
                const parts = docPath.split('/');
                const [collectionName, docId, subCollectionName, subDocId] = parts;

                if (collectionName === 'users' && docId && subCollectionName === 'profile' && subDocId === 'data') {
                    const userEmail = Object.keys(mockUsers).find(email => mockUsers[email].uid === docId);
                    if (userEmail && mockUsers[userEmail].profile) {
                        return { exists: () => true, data: () => ({ ...mockUsers[userEmail].profile }) };
                    }
                } else if (collectionName === 'products' && docId) {
                    const product = mockProducts.find(p => p.id === docId);
                    if (product) {
                        return { exists: () => true, data: () => ({ ...product }) };
                    }
                } else if (collectionName === 'appConfig' && docId === 'settings') {
                    return { exists: () => true, data: () => ({ ...mockAppConfig }) };
                }
                return { exists: () => false, data: () => undefined };
            }

            async setDoc(docPath, data) {
                console.log("Mock Firestore: setDoc on", docPath, "with data", data);
                const parts = docPath.split('/');
                const [collectionName, docId, subCollectionName, subDocId] = parts;

                if (collectionName === 'users' && docId && subCollectionName === 'profile' && subDocId === 'data') {
                    const userEmail = Object.keys(mockUsers).find(email => mockUsers[userEmail].uid === docId);
                    if (userEmail) {
                        mockUsers[userEmail].profile = { ...mockUsers[userEmail].profile, ...data };
                    }
                } else if (collectionName === 'products' && docId) {
                    const index = mockProducts.findIndex(p => p.id === docId);
                    if (index > -1) {
                        mockProducts[index] = { ...mockProducts[index], ...data };
                    } else {
                        mockProducts.push({ id: docId, ...data });
                    }
                } else if (collectionName === 'appConfig' && docId === 'settings') {
                    mockAppConfig = { ...mockAppConfig, ...data };
                }
                this._notifyListeners(docPath);
            }

            async addDoc(collectionPath, data) {
                console.log("Mock Firestore: addDoc to", collectionPath, "with data", data);
                const [collectionName, userId, subCollectionName] = collectionPath.split('/');
                const newId = this._generateId();

                if (collectionName === 'products') {
                    const newProduct = { id: newId, ...data };
                    mockProducts.push(newProduct);
                    this._notifyListeners('products');
                    return { id: newId };
                } else if (collectionName === 'users' && userId && subCollectionName === 'favorites') {
                    mockUserFavorites[userId] = mockUserFavorites[userId] || [];
                    if (!mockUserFavorites[userId].includes(data.productId)) {
                        mockUserFavorites[userId].push(data.productId);
                    }
                    this._notifyListeners(`users/${userId}/favorites`);
                    return { id: data.productId };
                } else if (collectionName === 'users' && userId && subCollectionName === 'cart') {
                    // Check stock before adding to cart (stock is still global for simplicity)
                    const product = mockProducts.find(p => p.id === data.productId);
                    if (!product || product.stock < data.quantity) {
                        throw new Error("Not enough stock.");
                    }

                    mockUserCarts[userId] = mockUserCarts[userId] || [];
                    // Find if item with same product ID, size, AND color already exists
                    const existingItemIndex = mockUserCarts[userId].findIndex(item =>
                        item.productId === data.productId &&
                        item.selectedSize === data.selectedSize &&
                        item.selectedColor === data.selectedColor
                    );
                    if (existingItemIndex > -1) {
                        // Check if adding more would exceed global stock
                        if (product.stock < (mockUserCarts[userId][existingItemIndex].quantity + data.quantity)) {
                            throw new Error("Not enough stock for additional quantity.");
                        }
                        mockUserCarts[userId][existingItemIndex].quantity += data.quantity;
                    } else {
                        mockUserCarts[userId].push({ productId: data.productId, quantity: data.quantity, selectedSize: data.selectedSize, selectedColor: data.selectedColor });
                    }
                    // Decrement global stock
                    product.stock -= data.quantity;
                    this._notifyListeners('products'); // Notify products to update stock display
                    this._notifyListeners(`users/${userId}/cart`);
                    return { id: data.productId };
                }
                return { id: newId };
            }

            async deleteDoc(docPath) {
                console.log("Mock Firestore: deleteDoc on", docPath);
                const parts = docPath.split('/');
                const [collectionName, docId, subCollectionName, subDocId] = parts;

                if (collectionName === 'products') {
                    mockProducts = mockProducts.filter(p => p.id !== docId);
                    this._notifyListeners('products');
                } else if (collectionName === 'users' && docId && subCollectionName === 'favorites' && subDocId) {
                    mockUserFavorites[docId] = (mockUserFavorites[docId] || []).filter(favId => favId !== subDocId);
                    this._notifyListeners(`users/${docId}/favorites`);
                } else if (collectionName === 'users' && docId && subCollectionName === 'cart' && subDocId) {
                    // For cart deletion, subDocId is productId. We need to filter by size and color.
                    // This mock simplifies: it removes the first entry for that productId regardless of size/color.
                    // A more robust solution would require passing size and color to delete specific cart items.
                    const cart = mockUserCarts[docId];
                    if (cart) {
                        const itemIndex = cart.findIndex(item => item.productId === subDocId); // This only finds first match
                        if (itemIndex > -1) {
                            const itemToRemove = cart[itemIndex];
                            const product = mockProducts.find(p => p.id === itemToRemove.productId);
                            if (product) {
                                product.stock += itemToRemove.quantity; // Return stock
                                this._notifyListeners('products'); // Notify products to update stock display
                            }
                            mockUserCarts[docId].splice(itemIndex, 1); // Remove item
                        }
                    }
                    this._notifyListeners(`users/${docId}/cart`);
                }
            }

            async updateDoc(docPath, data) {
                console.log("Mock Firestore: updateDoc on", docPath, "with data", data);
                const parts = docPath.split('/');
                const [collectionName, docId, subCollectionName, subDocId] = parts;

                if (collectionName === 'users' && docId && subCollectionName === 'profile' && subDocId === 'data') {
                    const userEmail = Object.keys(mockUsers).find(email => mockUsers[userEmail].uid === docId);
                    if (userEmail) {
                        mockUsers[userEmail].profile = { ...mockUsers[userEmail].profile, ...data };
                        this._notifyListeners(`users/${docId}/profile/data`);
                    }
                } else if (collectionName === 'users' && docId && subCollectionName === 'cart' && subDocId) {
                    const cart = mockUserCarts[docId];
                    if (cart) {
                        // For cart update, subDocId is productId. We need to find by size and color.
                        // Assuming data.selectedSize and data.selectedColor are passed for specific item updates.
                        const itemIndex = cart.findIndex(item =>
                            item.productId === subDocId &&
                            (item.selectedSize === data.selectedSize || (!item.selectedSize && !data.selectedSize)) &&
                            (item.selectedColor === data.selectedColor || (!item.selectedColor && !data.selectedColor))
                        );
                        if (itemIndex > -1) {
                            const oldQuantity = cart[itemIndex].quantity;
                            const newQuantity = data.quantity;
                            const product = mockProducts.find(p => p.id === subDocId);

                            if (product) {
                                const quantityChange = newQuantity - oldQuantity;
                                if (product.stock < quantityChange) {
                                    throw new Error("Not enough stock for this quantity change.");
                                }
                                product.stock -= quantityChange; // Adjust stock
                                this._notifyListeners('products'); // Notify products to update stock display
                            }
                            mockUserCarts[docId][itemIndex].quantity = newQuantity;
                            this._notifyListeners(`users/${docId}/cart`);
                        }
                    }
                } else if (collectionName === 'products' && docId) {
                    const index = mockProducts.findIndex(p => p.id === docId);
                    if (index > -1) {
                        mockProducts[index] = { ...mockProducts[index], ...data };
                        this._notifyListeners('products');
                    }
                } else if (collectionName === 'appConfig' && docId === 'settings') {
                    mockAppConfig = { ...mockAppConfig, ...data };
                    this._notifyListeners('appConfig/settings');
                }
            }

            // Simulate real-time listeners for collections/documents
            onSnapshot(path, callback) {
                console.log(`onSnapshot attached for path: ${path}`);
                if (!this._listeners[path]) {
                    this._listeners[path] = [];
                }
                this._listeners[path].push(callback);

                // Initial call with current data
                if (path === 'products') {
                    callback({ docs: mockProducts.map(p => ({ id: p.id, data: () => ({ ...p }) })) });
                } else if (path.startsWith('users/') && path.endsWith('/favorites')) {
                    const userId = path.split('/')[1];
                    const favoriteIds = mockUserFavorites[userId] || [];
                    callback({ docs: favoriteIds.map(id => ({ id: id, data: () => ({ productId: id }) })) });
                } else if (path.startsWith('users/') && path.endsWith('/cart')) {
                    const userId = path.split('/')[1];
                    const cartItems = mockUserCarts[userId] || [];
                    callback({ docs: cartItems.map(item => ({ id: item.productId, data: () => ({ ...item }) })) });
                } else if (path.startsWith('users/') && path.endsWith('/profile/data')) {
                    const userId = path.split('/')[1];
                    const userEmail = Object.keys(mockUsers).find(email => mockUsers[email].uid === userId);
                    const userData = userEmail ? mockUsers[userEmail].profile : null;
                    callback({ exists: () => !!userData, data: () => userData ? { ...userData } : undefined });
                } else if (path === 'appConfig/settings') {
                    callback({ exists: () => true, data: () => ({ ...mockAppConfig }) });
                }

                // Return an unsubscribe function
                return () => {
                    console.log(`onSnapshot unsubscribed for path: ${path}`);
                    this._listeners[path] = this._listeners[path].filter(l => l !== callback);
                };
            }
        }

        class StorageService {
            // This is a simple mock. In a real app, images would be uploaded to cloud storage.
            // Here, we just return the Data URL or a placeholder.
            async uploadFile(file, path) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        console.log(`Mock Storage: Uploaded ${file.name} to ${path}`);
                        resolve({ downloadURL: e.target.result }); // Return Data URL as download URL
                    };
                    reader.readAsDataURL(file);
                });
            }

            async deleteFile(url) {
                console.log(`Mock Storage: Deleted file with URL: ${url}`);
                return Promise.resolve(); // Simulate successful deletion
            }
        }

        const authService = new AuthService();
        const firestoreService = new FirestoreService();
        const storageService = new StorageService();

        // --- GLOBAL UI ELEMENTS & STATE ---
        const pageContent = document.getElementById('pageContent');
        const favoritesSection = document.getElementById('favoritesSection'); // New
        const cartSection = document.getElementById('cartSection');           // New
        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection');
        const forgotPasswordSection = document.getElementById('forgotPasswordSection');
        const profileSection = document.getElementById('profileSection');
        const adminSection = document.getElementById('adminSection');
        const loadingIndicator = document.getElementById('loadingIndicator');

        const loginNavBtn = document.getElementById('loginNavBtn');
        const registerNavBtn = document.getElementById('registerNavBtn');
        const profileNavBtn = document.getElementById('profileNavBtn');
        const adminNavBtn = document.getElementById('adminNavBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authLinks = document.getElementById('authLinks');
        const userProfileLink = document.getElementById('userProfileLink');
        const favoritesBtn = document.getElementById('favoritesBtn');
        const cartBtn = document.getElementById('cartBtn');

        const messageModal = document.getElementById('messageModal');
        const modalMessageText = document.getElementById('modalMessageText');
        const closeModalBtn = document.getElementById('closeModalBtn');

        const boutiqueBtn = document.getElementById('boutiqueBtn');
        const makeupBtn = document.getElementById('makeupBtn');

        // Product Search and Filter elements (now directly in HTML)
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const minPriceInput = document.getElementById('minPriceInput');
        const maxPriceInput = document.getElementById('maxPriceInput');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const productGridContainer = document.getElementById('productGridContainer');

        // New UI elements for expandable search/filter
        const searchIconBtn = document.getElementById('searchIconBtn');
        const filterIconBtn = document.getElementById('filterIconBtn');
        const expandedSearchContainer = document.getElementById('expandedSearchContainer');
        const expandedFilterContainer = document.getElementById('expandedFilterContainer');
        const closeSearchBtn = document.getElementById('closeSearchBtn');
        const closeFilterBtn = document.getElementById('closeFilterBtn');


        // Admin elements
        const discountForm = document.getElementById('discountForm');
        const globalDiscountInput = document.getElementById('globalDiscount');
        const currentDiscountDisplay = document.getElementById('currentDiscountDisplay');
        const addProductForm = document.getElementById('addProductForm');
        const productNameInput = document.getElementById('productName');
        const productDescriptionTextarea = document.getElementById('productDescription');
        const productPriceInput = document.getElementById('productPrice');
        const productStockInput = document.getElementById('productStock'); // New stock input
        const productCategorySelect = document.getElementById('productCategory');
        // New: Product Sizes Admin Elements
        const productSizesContainer = document.getElementById('productSizesContainer');
        const sizeSelector = document.getElementById('sizeSelector');
        const addSizeBtn = document.getElementById('addSizeBtn');
        const addedSizesList = document.getElementById('addedSizesList');
        const noSizesText = document.getElementById('noSizesText');

        // New elements for colors and images in Admin
        const productColorsAndImagesContainer = document.getElementById('productColorsAndImagesContainer');
        const colorNameInput = document.getElementById('colorNameInput');
        const colorPickerInput = document.getElementById('colorPickerInput'); // New color picker input
        const colorImageUploadInput = document.getElementById('colorImageUploadInput');
        const selectColorImagesBtn = document.getElementById('selectColorImagesBtn');
        const addColorsAndImagesBtn = document.getElementById('addColorsAndImagesBtn');
        const colorImagePreviewContainer = document.getElementById('colorImagePreviewContainer');
        const noColorImagesText = document.getElementById('noColorImagesText');
        const addedColorsAndImagesList = document.getElementById('addedColorsAndImagesList');
        const noColorsAddedText = document.getElementById('noColorsAddedText');

        const productImageUploadInput = document.getElementById('productImageUpload'); // Now hidden
        const imagePreviewContainer = document.getElementById('imagePreviewContainer'); // Now hidden
        const accessoryNameInput = document.getElementById('accessoryName');
        const addAccessoryBtn = document.getElementById('addAccessoryBtn');
        const accessoriesListContainer = document.getElementById('accessoriesListContainer');
        const noAccessoriesText = document.getElementById('noAccessoriesText');
        const generateDescBtn = document.getElementById('generateDescBtn');
        const descLoadingSpinner = document.getElementById('descLoadingSpinner');
        const productIndividualDiscountInput = document.getElementById('productIndividualDiscount'); // New individual discount input
        const adminProductList = document.getElementById('adminProductList'); // Admin product list container

        // Admin Credentials elements
        const adminCredentialsForm = document.getElementById('adminCredentialsForm');
        const adminCurrentPasswordInput = document.getElementById('adminCurrentPassword');
        const adminNewUsernameInput = document.getElementById('adminNewUsername');
        const adminNewPasswordInput = document.getElementById('adminNewPassword');
        const adminConfirmNewPasswordInput = document.getElementById('adminConfirmNewPassword');

        // Social Media elements
        const socialMediaForm = document.getElementById('socialMediaForm');
        const socialFacebookInput = document.getElementById('socialFacebook');
        const socialInstagramInput = document.getElementById('socialInstagram');
        const socialTwitterInput = document.getElementById('socialTwitter');
        const socialTiktokInput = document.getElementById('socialTiktok');
        const socialWhatsappInput = document.getElementById('socialWhatsapp'); // New WhatsApp input
        const socialMediaIconsContainer = document.getElementById('socialMediaIcons'); // Container for footer icons
        const facebookLink = document.getElementById('facebookLink');
        const instagramLink = document.getElementById('instagramLink');
        const twitterLink = document.getElementById('twitterLink');
        const tiktokLink = document.getElementById('tiktokLink');
        const whatsappFloatBtn = document.getElementById('whatsappFloatBtn'); // Floating WhatsApp button

        // Mission and Vision elements
        const missionVisionDisplay = document.getElementById('missionVisionDisplay');
        const missionVisionTextElement = document.getElementById('missionVisionText');
        const missionVisionForm = document.getElementById('missionVisionForm');
        const missionVisionTextarea = document.getElementById('missionVisionTextarea');

        // New Header Background elements
        const mainHeader = document.getElementById('mainHeader'); // Get the header element
        const headerBackgroundForm = document.getElementById('headerBackgroundForm'); // This is now a container for buttons
        const headerBgColorRadio = document.getElementById('headerBgColorRadio');
        const headerBgImageRadio = document.getElementById('headerBgImageRadio');
        const headerBgColorOptions = document.getElementById('headerBgColorOptions');
        const headerBgImageOptions = document.getElementById('headerBgImageOptions');
        const headerBgColorInput = document.getElementById('headerBgColor');
        const headerBgImageUpload = document.getElementById('headerBgImageUpload');
        const headerBgImagePreview = document.getElementById('headerBgImagePreview');
        const previewHeaderBgBtn = document.getElementById('previewHeaderBgBtn'); // New preview button
        const saveHeaderBgBtn = document.getElementById('saveHeaderBgBtn');       // New save button


        // Product Detail Modal elements
        const productDetailModal = document.getElementById('productDetailModal');
        const closeProductDetailModalBtn = document.getElementById('closeProductDetailModal');
        const productDetailImage = document.getElementById('productDetailImage');
        const prevImageBtn = document.getElementById('prevImageBtn');
        const nextImageBtn = document.getElementById('nextImageBtn');
        const productDetailDots = document.getElementById('productDetailDots');
        const productDetailName = document.getElementById('productDetailName');
        const productDetailOriginalPrice = document.getElementById('productDetailOriginalPrice');
        const productDetailDiscountedPrice = document.getElementById('productDetailDiscountedPrice');
        const productDetailDescription = document.getElementById('productDetailDescription');
        const productDetailAccessoriesList = document.getElementById('productDetailAccessoriesList');
        // Product Detail Sizes Display (now using generic 'options' class)
        const productDetailSizes = document.getElementById('productDetailSizes');
        const productDetailSizesList = document.getElementById('productDetailSizesList');
        // Product Detail Colors Display (new)
        const productDetailColors = document.getElementById('productDetailColors');
        const productDetailColorsList = document.getElementById('productDetailColorsList');


        const productDetailAddToCartBtn = document.getElementById('productDetailAddToCartBtn');
        const productDetailStock = document.getElementById('productDetailStock'); // New stock display in detail modal

        let currentProductDetailImages = []; // To store image URLs for the product detail modal
        let currentProductDetailImageIndex = 0; // Current image index for the product detail modal carousel

        let currentCategory = 'Boutique'; // Default category
        let productSizes = []; // New: To store sizes for the product being added/edited in admin

        let productColorImageSets = []; // Stores { color: string, urls: string[] } for admin product creation
        let currentImagesForColor = []; // Temporary array for images being uploaded for the current color input

        // Variables for header background dragging
        let isDraggingHeaderBg = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let initialBgPosX = 50; // Stored as percentage
        let initialBgPosY = 50; // Stored as percentage
        let isHeaderBackgroundEditingMode = false; // New: Controls if dragging is allowed


        // --- UTILITY FUNCTIONS ---
        function showLoading() {
            loadingIndicator.style.display = 'block';
            // Hide all sections except loading to prevent overlap
            hideAllContentSections();
        }

        function hideLoading() {
            loadingIndicator.style.display = 'none';
            // The appropriate content section will be shown by the calling function
        }

        function showModal(message) {
            modalMessageText.textContent = message;
            messageModal.style.display = 'block';
        }

        function hideModal() {
            messageModal.style.display = 'none';
        }

        // Function to hide all main content sections (forms, admin, profile, etc.)
        function hideAllContentSections() {
            pageContent.style.display = 'none'; // Ensure main product content is also hidden
            favoritesSection.style.display = 'none'; // Hide favorites section
            cartSection.style.display = 'none';     // Hide cart section
            loginSection.style.display = 'none';
            registerSection.style.display = 'none';
            forgotPasswordSection.style.display = 'none';
            profileSection.style.display = 'none';
            adminSection.style.display = 'none';
            productDetailModal.style.display = 'none'; // Ensure product detail modal is hidden
            isHeaderBackgroundEditingMode = false; // Exit editing mode when hiding admin section
            mainHeader.classList.remove('editing-mode'); // Remove editing class from header
        }

        // Function to show a specific content section and hide others
        function showContentSection(sectionElement) {
            hideAllContentSections(); // Hide all first
            sectionElement.style.display = 'block'; // Then show the desired one
            // Admin section uses flex, so handle it specifically
            if (sectionElement === adminSection) {
                sectionElement.style.display = 'flex';
            }
        }

        // Function to hide all expanded search/filter controls
        function hideAllExpandedControls() {
            expandedSearchContainer.style.display = 'none';
            expandedFilterContainer.style.display = 'none';
        }

        function calculatePriceWithDiscount(originalPrice, productDiscount) {
            const globalDiscount = mockAppConfig.globalDiscount || 0;
            const effectiveDiscount = Math.max(globalDiscount, productDiscount || 0); // Individual discount overrides global if higher
            if (effectiveDiscount > 0) {
                const discountedPrice = originalPrice * (1 - effectiveDiscount / 100);
                return { price: discountedPrice.toFixed(2), percentage: effectiveDiscount };
            }
            return { price: originalPrice.toFixed(2), percentage: 0 }; // No discount
        }

        // --- RENDER FUNCTIONS ---

        async function renderProducts(category = null, searchQuery = '', minPrice = null, maxPrice = null) {
            console.log(`Rendering products for category: ${category}, search: "${searchQuery}", price: ${minPrice}-${maxPrice}`);
            showLoading();
            let productsToDisplay = mockProducts;

            // Apply category filter
            if (category && category !== 'All') {
                productsToDisplay = productsToDisplay.filter(p => p.category === category);
            }

            // Apply search filter
            if (searchQuery) {
                const lowerCaseQuery = searchQuery.toLowerCase();
                productsToDisplay = productsToDisplay.filter(p =>
                    p.name.toLowerCase().includes(lowerCaseQuery) ||
                    p.description.toLowerCase().includes(lowerCaseQuery) ||
                    p.accessories.some(acc => acc.toLowerCase().includes(lowerCaseQuery)) ||
                    (p.sizes && p.sizes.some(size => size.toLowerCase().includes(lowerCaseQuery))) || // Search by size
                    (p.imageSets && p.imageSets.some(set => set.color.toLowerCase().includes(lowerCaseQuery))) // Search by color
                );
            }

            // Apply price filters
            if (minPrice !== null && !isNaN(minPrice)) {
                productsToDisplay = productsToDisplay.filter(p => p.price >= minPrice);
            }
            if (maxPrice !== null && !isNaN(maxPrice)) {
                productsToDisplay = productsToDisplay.filter(p => p.price <= maxPrice);
            }

            productGridContainer.innerHTML = ''; // Clear previous product grid content

            if (productsToDisplay.length === 0) {
                productGridContainer.innerHTML = '<p class="col-span-full text-center text-gray-500 text-lg">No hay productos que coincidan con los filtros.</p>';
            } else {
                for (const product of productsToDisplay) {
                    const isFavorite = authService.currentUser && mockUserFavorites[authService.currentUser.uid] && mockUserFavorites[authService.currentUser.uid].includes(product.id);
                    const favoriteClass = isFavorite ? 'active' : '';
                    const isOutOfStock = product.stock <= 0;
                    const stockText = isOutOfStock ? '<span class="text-red-500 font-bold">Agotado</span>' : `<span class="text-green-600">En Stock (${product.stock})</span>`;
                    const addToCartDisabled = isOutOfStock ? 'disabled' : '';
                    const addToCartClass = isOutOfStock ? 'opacity-50 cursor-not-allowed' : '';

                    // Get the first image from the first color set for the product card thumbnail
                    const thumbnailSrc = product.imageSets && product.imageSets.length > 0 && product.imageSets[0].urls.length > 0
                        ? product.imageSets[0].urls[0]
                        : 'https://placehold.co/400x300/cccccc/333333?text=No+Image';

                    // Calculate discounted price and percentage
                    const { price: discountedPrice, percentage: discountPercentage } = calculatePriceWithDiscount(product.price, product.discountPercentage);

                    const productCardHtml = `
                        <div class="product-card" data-product-id="${product.id}">
                            <img src="${thumbnailSrc}" alt="${product.name}" class="product-image">
                            <div class="product-card-content">
                                <h3 class="text-lg font-semibold text-gray-900">${product.name}</h3>
                                <div class="flex items-baseline mb-2">
                    `;
                    let priceHtml = '';
                    if (discountPercentage > 0) {
                        priceHtml = `
                                    <span class="text-gray-500 line-through mr-2">$${product.price.toFixed(2)}</span>
                                    <span class="text-red-600 font-bold text-xl">$${discountedPrice}</span>
                                    <span class="discount-badge">-${discountPercentage}%</span>
                        `;
                    } else {
                        priceHtml = `<span class="text-gray-900 font-bold text-xl">$${product.price.toFixed(2)}</span>`;
                    }

                    productGridContainer.innerHTML += productCardHtml + priceHtml + `
                                </div>
                                <p class="text-sm font-semibold text-gray-700">${stockText}</p>
                                <p class="text-gray-600 text-sm mb-4 line-clamp-3">${product.description}</p>
                                <div class="product-card-actions flex justify-between items-center">
                                    <button class="btn-primary text-sm add-to-cart-btn ${addToCartClass}" data-product-id="${product.id}" ${addToCartDisabled}>
                                        <i class="fas fa-shopping-cart mr-2"></i> Añadir
                                    </button>
                                    <button class="favorite-btn text-gray-400 hover:text-pink-500 ${favoriteClass}" data-product-id="${product.id}">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            hideLoading();
            showContentSection(pageContent); // Ensure pageContent is visible after loading
            attachProductCardListeners(); // Attach listener to open detail modal
            attachAddToCartListeners();
            attachFavoriteListeners();
        }

        // New: Function to open and populate product detail modal
        let selectedProductSize = null; // To store the currently selected size in the detail modal
        let selectedProductColor = null; // To store the currently selected color in the detail modal

        function openProductDetailModal(product) {
            console.log('Opening product detail modal for:', product.name);
            
            // Determine which image set to use initially (first one, or 'Default' if exists)
            let initialImageSet = null;
            if (product.imageSets && product.imageSets.length > 0) {
                initialImageSet = product.imageSets.find(set => set.color.toLowerCase() === 'default') || product.imageSets[0];
            }

            currentProductDetailImages = initialImageSet ? initialImageSet.urls : [];
            currentProductDetailImageIndex = 0;
            selectedProductSize = null; // Reset selected size
            selectedProductColor = initialImageSet ? initialImageSet.color : null; // Set initial selected color

            productDetailName.textContent = product.name;
            productDetailDescription.textContent = product.description;
            
            const isOutOfStock = product.stock <= 0;
            const stockText = isOutOfStock ? '<span class="text-red-500 font-bold">Agotado</span>' : `<span class="text-green-600">En Stock (${product.stock})</span>`;
            productDetailStock.innerHTML = `Stock: ${stockText}`;
            productDetailAddToCartBtn.disabled = isOutOfStock;
            productDetailAddToCartBtn.classList.toggle('opacity-50', isOutOfStock);
            productDetailAddToCartBtn.classList.toggle('cursor-not-allowed', isOutOfStock);


            const { price: discountedPrice, percentage: discountPercentage } = calculatePriceWithDiscount(product.price, product.discountPercentage);
            
            if (discountPercentage > 0) {
                productDetailOriginalPrice.textContent = `$${product.price.toFixed(2)}`;
                productDetailOriginalPrice.style.display = 'inline';
                productDetailDiscountedPrice.textContent = `$${discountedPrice}`;
            } else {
                productDetailOriginalPrice.style.display = 'none';
                productDetailDiscountedPrice.textContent = `$${product.price.toFixed(2)}`;
            }

            // Render Accessories
            productDetailAccessoriesList.innerHTML = '';
            if (product.accessories && product.accessories.length > 0) {
                product.accessories.forEach(accessory => {
                    const span = document.createElement('span');
                    span.textContent = accessory;
                    span.classList.add('bg-gray-200', 'px-2', 'py-1', 'rounded-md', 'text-sm');
                    productDetailAccessoriesList.appendChild(span);
                });
            } else {
                productDetailAccessoriesList.textContent = 'No se incluyen accesorios.';
            }

            // Render Sizes (existing logic)
            productDetailSizesList.innerHTML = '';
            if (product.category === 'Boutique' && product.sizes && product.sizes.length > 0) {
                productDetailSizes.style.display = 'block';
                product.sizes.forEach(size => {
                    const span = document.createElement('span');
                    span.textContent = size;
                    span.classList.add('product-detail-size-item');
                    span.dataset.size = size;
                    span.addEventListener('click', () => {
                        document.querySelectorAll('.product-detail-size-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        span.classList.add('selected');
                        selectedProductSize = size;
                        console.log('Selected size:', selectedProductSize);
                    });
                    productDetailSizesList.appendChild(span);
                });
                if (product.sizes.length > 0) {
                    const firstSizeElement = productDetailSizesList.querySelector('.product-detail-size-item');
                    if (firstSizeElement) {
                        firstSizeElement.classList.add('selected');
                        selectedProductSize = firstSizeElement.dataset.size;
                    }
                }
            } else {
                productDetailSizes.style.display = 'none';
                selectedProductSize = null;
            }

            // Render Colors (new logic)
            productDetailColorsList.innerHTML = '';
            // Only show color circles if multiple colors exist OR if it's a Boutique product with at least one color (even if just "Default")
            if (product.category === 'Boutique' && product.imageSets && product.imageSets.length > 0) {
                productDetailColors.style.display = 'block';
                product.imageSets.forEach(colorSet => {
                    const colorCircle = document.createElement('div');
                    colorCircle.classList.add('product-detail-color-circle');
                    colorCircle.style.backgroundColor = colorSet.color.toLowerCase(); // Use color name as background
                    colorCircle.dataset.color = colorSet.color;

                    if (colorSet.color === selectedProductColor) {
                        colorCircle.classList.add('selected'); // Add selected class for initial selection
                    }

                    colorCircle.addEventListener('click', () => {
                        document.querySelectorAll('.product-detail-color-circle').forEach(item => {
                            item.classList.remove('selected');
                        });
                        colorCircle.classList.add('selected');

                        selectedProductColor = colorSet.color;
                        currentProductDetailImages = colorSet.urls;
                        currentProductDetailImageIndex = 0;
                        updateProductDetailImage();
                        updateProductDetailDots();
                        console.log('Selected color:', selectedProductColor);
                    });
                    productDetailColorsList.appendChild(colorCircle);
                });
            } else {
                productDetailColors.style.display = 'none'; // Hide colors container if not boutique or only one color
                selectedProductColor = initialImageSet ? initialImageSet.color : null; // Ensure selectedProductColor is set for single-color products
            }

            productDetailAddToCartBtn.dataset.productId = product.id;
            // Add selected color to dataset for add to cart button
            productDetailAddToCartBtn.dataset.selectedColor = selectedProductColor;

            updateProductDetailImage();
            updateProductDetailDots();
            productDetailModal.style.display = 'flex';
        }

        function updateProductDetailImage() {
            productDetailImage.src = currentProductDetailImages[currentProductDetailImageIndex] || 'https://placehold.co/400x300/cccccc/333333?text=No+Image';
        }

        function updateProductDetailDots() {
            productDetailDots.innerHTML = '';
            currentProductDetailImages.forEach((_, index) => {
                const dot = document.createElement('span');
                dot.classList.add('product-detail-dot');
                if (index === currentProductDetailImageIndex) {
                    dot.classList.add('active');
                }
                dot.addEventListener('click', () => {
                    currentProductDetailImageIndex = index;
                    updateProductDetailImage();
                    updateProductDetailDots();
                });
                productDetailDots.appendChild(dot);
            });
        }

        function navigateProductDetailImage(direction) {
            currentProductDetailImageIndex += direction;
            if (currentProductDetailImageIndex < 0) {
                currentProductDetailImageIndex = currentProductDetailImages.length - 1;
            } else if (currentProductDetailImageIndex >= currentProductDetailImages.length) {
                currentProductDetailImageIndex = 0;
            }
            updateProductDetailImage();
            updateProductDetailDots();
        }


        // --- EVENT LISTENERS ---

        // Universal close for message modal
        closeModalBtn.addEventListener('click', hideModal);
        window.addEventListener('click', (event) => {
            if (event.target === messageModal) {
                hideModal();
            }
            if (event.target === productDetailModal) {
                productDetailModal.style.display = 'none';
            }
        });

        // Product Detail Modal navigation
        closeProductDetailModalBtn.addEventListener('click', () => {
            productDetailModal.style.display = 'none';
        });
        prevImageBtn.addEventListener('click', () => navigateProductDetailImage(-1));
        nextImageBtn.addEventListener('click', () => navigateProductDetailImage(1));


        // Dynamic Product Card Listener (for opening detail modal)
        function attachProductCardListeners() {
            console.log('Attaching product card listeners...');
            document.querySelectorAll('.product-card').forEach(card => {
                card.addEventListener('click', async (event) => {
                    // Prevent opening modal if a button inside the card was clicked
                    if (event.target.closest('button')) {
                        console.log('Clicked button inside card, not opening detail modal.');
                        return;
                    }
                    const productId = card.dataset.productId;
                    const product = mockProducts.find(p => p.id === productId);
                    if (product) {
                        openProductDetailModal(product);
                    } else {
                        console.error('Product not found for ID:', productId);
                    }
                });
            });
        }

        function attachAddToCartListeners() {
            console.log('Attaching add to cart listeners...');
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    event.stopPropagation(); // Prevent card click event from bubbling up
                    const productId = button.dataset.productId;
                    // For card view, we don't have color selection, so use the first color if available
                    const product = mockProducts.find(p => p.id === productId);
                    let colorToAdd = null;
                    let sizeToAdd = null; // Also handle size for card view

                    if (product) {
                        // Default to the first color in the set if available
                        if (product.imageSets && product.imageSets.length > 0) {
                            colorToAdd = product.imageSets[0].color;
                        }
                        // Default to the first size if available for Boutique products
                        if (product.category === 'Boutique' && product.sizes && product.sizes.length > 0) {
                            sizeToAdd = product.sizes[0];
                        }
                    }

                    console.log('Add to cart clicked for product:', productId, 'size:', sizeToAdd, 'color:', colorToAdd);
                    if (!authService.currentUser || authService.currentUser.isAnonymous) {
                        showModal('Por favor, inicia sesión para añadir productos al carrito.');
                        return;
                    }
                    
                    if (!product || product.stock <= 0) {
                        showModal('Este producto está agotado.');
                        return;
                    }

                    try {
                        // Pass selectedSize (can be null from card view) and selectedColor to addDoc
                        await firestoreService.addDoc(`users/${authService.currentUser.uid}/cart`, { productId: productId, quantity: 1, selectedSize: sizeToAdd, selectedColor: colorToAdd });
                        showModal('Producto añadido al carrito.');
                        applyFilters();
                    } catch (error) {
                        console.error("Error adding to cart:", error);
                        showModal(`Error al añadir producto al carrito: ${error.message}`);
                    }
                });
            });

            // Add to cart from product detail modal
            productDetailAddToCartBtn.addEventListener('click', async () => {
                const productId = productDetailAddToCartBtn.dataset.productId;
                // Use selectedProductColor and selectedProductSize from the modal's state
                const colorToAdd = selectedProductColor;
                const sizeToAdd = selectedProductSize;
                console.log('Add to cart clicked from detail modal for product:', productId, 'size:', sizeToAdd, 'color:', colorToAdd);
                if (!authService.currentUser || authService.currentUser.isAnonymous) {
                    showModal('Por favor, inicia sesión para añadir productos al carrito.');
                    return;
                }
                const product = mockProducts.find(p => p.id === productId);
                if (!product || product.stock <= 0) {
                    showModal('Este producto está agotado.');
                    return;
                }

                if (product.category === 'Boutique' && product.sizes && product.sizes.length > 0 && !selectedProductSize) {
                    showModal('Por favor, selecciona una talla para este producto.');
                    return;
                }
                // If it's a Boutique product with multiple colors, ensure a color is selected
                if (product.category === 'Boutique' && product.imageSets && product.imageSets.length > 1 && !selectedProductColor) {
                    showModal('Por favor, selecciona un color para este producto.');
                    return;
                }

                try {
                    // Pass selectedSize and selectedColor to addDoc
                    await firestoreService.addDoc(`users/${authService.currentUser.uid}/cart`, { productId: productId, quantity: 1, selectedSize: sizeToAdd, selectedColor: colorToAdd });
                    showModal('Producto añadido al carrito.');
                    applyFilters();
                    productDetailModal.style.display = 'none';
                } catch (error) {
                    console.error("Error adding to cart from detail modal:", error);
                    showModal(`Error al añadir producto al carrito: ${error.message}`);
                }
            });
        }


        function attachFavoriteListeners() {
            console.log('Attaching favorite listeners...');
            document.querySelectorAll('.favorite-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    event.stopPropagation(); // Prevent card click event from bubbling up
                    const productId = button.dataset.productId;
                    console.log('Favorite button clicked for product:', productId);
                    if (!authService.currentUser || authService.currentUser.isAnonymous) {
                        showModal('Por favor, inicia sesión para añadir productos a favoritos.');
                        return;
                    }
                    try {
                        const userId = authService.currentUser.uid;
                        const isFavorite = mockUserFavorites[userId] && mockUserFavorites[userId].includes(productId);

                        if (isFavorite) {
                            await firestoreService.deleteDoc(`users/${userId}/favorites/${productId}`);
                            showModal('Producto eliminado de favoritos.');
                        } else {
                            await firestoreService.addDoc(`users/${userId}/favorites`, { productId: productId });
                            showModal('Producto añadido a favoritos.');
                        }
                        // updateFavoritesCount is handled by the onSnapshot listener
                        button.classList.toggle('active', !isFavorite); // Update UI immediately for visual feedback
                    } catch (error) {
                        console.error("Error updating favorites:", error);
                        showModal(`Error al actualizar favoritos: ${error.message}`);
                    }
                });
            });
        }


        // Navigation buttons
        boutiqueBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Boutique clicked');
            currentCategory = 'Boutique';
            categoryFilter.value = 'Boutique';
            applyFilters();
            setActiveNav('boutiqueBtn');
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top
        });
        makeupBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Make Up clicked');
            currentCategory = 'Make Up';
            categoryFilter.value = 'Make Up';
            applyFilters();
            setActiveNav('makeupBtn');
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top
        });

        loginNavBtn.addEventListener('click', (e) => { e.preventDefault(); console.log('Login Nav clicked'); showContentSection(loginSection); setActiveNav('loginNavBtn'); });
        registerNavBtn.addEventListener('click', (e) => { e.preventDefault(); console.log('Register Nav clicked'); showContentSection(registerSection); setActiveNav('registerNavBtn'); });
        profileNavBtn.addEventListener('click', (e) => { e.preventDefault(); console.log('Profile Nav clicked'); showContentSection(profileSection); showProfileSection(); setActiveNav('profileNavBtn'); });
        adminNavBtn.addEventListener('click', (e) => { e.preventDefault(); console.log('Admin Nav clicked'); showContentSection(adminSection); showAdminSection(); setActiveNav('adminNavBtn'); });
        logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); console.log('Logout clicked'); await authService.signOut(); showModal("Sesión cerrada correctamente."); });

        favoritesBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Favorites clicked');
            if (authService.currentUser && !authService.currentUser.isAnonymous) {
                showContentSection(favoritesSection); // Show favorites section
                renderFavorites();
                setActiveNav('favoritesBtn');
            } else {
                showModal('Por favor, inicia sesión para ver tus favoritos.');
            }
        });

        cartBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Cart clicked');
            if (authService.currentUser && !authService.currentUser.isAnonymous) {
                showContentSection(cartSection); // Show cart section
                renderCart();
                setActiveNav('cartBtn');
            } else {
                showModal('Por favor, inicia sesión para ver tu carrito.');
            }
        });

        document.getElementById('showRegisterFromLogin').addEventListener('click', (e) => { e.preventDefault(); console.log('Show Register from Login clicked'); showContentSection(registerSection); });
        document.getElementById('showLoginFromRegister').addEventListener('click', (e) => { e.preventDefault(); console.log('Show Login from Register clicked'); showContentSection(loginSection); });
        document.getElementById('forgotPasswordLink').addEventListener('click', (e) => { e.preventDefault(); console.log('Forgot Password clicked'); showContentSection(forgotPasswordSection); });
        document.getElementById('backToLoginFromForgot').addEventListener('click', (e) => { e.preventDefault(); console.log('Back to Login from Forgot clicked'); showContentSection(loginSection); });

        // --- AUTH FORMS ---

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Login form submitted');
            const email = loginEmail.value;
            const password = loginPassword.value;
            try {
                showLoading();
                await authService.signInWithEmailAndPassword(email, password);
                showModal('¡Inicio de sesión exitoso!');
                loginForm.reset();
                showContentSection(pageContent); // Go to main content after login
                applyFilters(); // Re-render products to reflect login state with current filters
            } catch (error) {
                let errorMessage = 'Error al iniciar sesión.';
                if (error.message.includes('auth/invalid-credential')) {
                    errorMessage = 'Credenciales incorrectas. Por favor, verifica tu email y contraseña.';
                } else if (error.message.includes('auth/user-not-found')) {
                     errorMessage = 'Usuario no encontrado. Regístrate si no tienes cuenta.';
                } else {
                    errorMessage = `Error: ${error.message}`;
                }
                showModal(errorMessage);
            } finally {
                hideLoading();
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Register form submitted');
            const fullName = registerFullName.value;
            const email = registerEmail.value;
            const phone = registerPhone.value;
            const address = registerAddress.value;
            const password = registerPassword.value;
            const confirmPassword = registerConfirmPassword.value;

            if (password !== confirmPassword) {
                showModal('Las contraseñas no coinciden.');
                return;
            }

            try {
                showLoading();
                const userCredential = await authService.createUserWithEmailAndPassword(email, password);
                await firestoreService.setDoc(`users/${userCredential.user.uid}/profile/data`, {
                    name: fullName,
                    phone: phone,
                    address: address,
                    createdAt: new Date().toISOString()
                });
                showModal('¡Cuenta creada exitosamente! Ya puedes iniciar sesión.');
                registerForm.reset();
                showContentSection(loginSection); // Go back to login
            } catch (error) {
                let errorMessage = 'Error al registrar usuario.';
                if (error.message.includes('auth/email-already-in-use')) {
                    errorMessage = 'El correo electrónico ya está en uso.';
                } else if (error.message.includes('auth/weak-password')) {
                    errorMessage = 'La contraseña debe tener al menos 6 caracteres.';
                } else {
                    errorMessage = `Error: ${error.message}`;
                }
                showModal(errorMessage);
            } finally {
                hideLoading();
            }
        });

        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Forgot password form submitted');
            const email = forgotPasswordEmail.value;
            try {
                showLoading();
                await authService.sendPasswordResetEmail(email);
                showModal('Se ha enviado un enlace de recuperación de contraseña a tu correo electrónico.');
                forgotPasswordForm.reset();
                showContentSection(loginSection); // Back to login
            } catch (error) {
                let errorMessage = 'Error al enviar el enlace de recuperación.';
                if (error.message.includes('auth/user-not-found')) {
                    errorMessage = 'No se encontró ningún usuario con ese correo electrónico.';
                } else {
                    errorMessage = `Error: ${error.message}`;
                }
                showModal(errorMessage);
            } finally {
                hideLoading();
            }
        });

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Profile form submitted');
            const fullName = document.getElementById('profileFullName').value;
            const phone = document.getElementById('profilePhone').value;
            const address = document.getElementById('profileAddress').value;

            if (authService.currentUser && !authService.currentUser.isAnonymous) {
                try {
                    showLoading();
                    await firestoreService.updateDoc(`users/${authService.currentUser.uid}/profile/data`, {
                        name: fullName,
                        phone: phone,
                        address: address
                    });
                    showModal('¡Perfil actualizado con éxito!');
                } catch (error) {
                    console.error("Error updating profile:", error);
                    showModal(`Error al actualizar perfil: ${error.message}`);
                } finally {
                    hideLoading();
                }
            } else {
                showModal('No tienes permiso para actualizar el perfil.');
            }
        });

        async function showProfileSection() {
            console.log('Showing profile section...');
            if (authService.currentUser && !authService.currentUser.isAnonymous) {
                showLoading();
                profileSection.style.display = 'block';
                document.getElementById('profileUserId').textContent = authService.currentUser.uid;
                try {
                    const profileDoc = await firestoreService.getDoc(`users/${authService.currentUser.uid}/profile/data`);
                    if (profileDoc.exists()) {
                        const profileData = profileDoc.data();
                        document.getElementById('profileFullName').value = profileData.name || '';
                        document.getElementById('profileEmail').value = authService.currentUser.email || '';
                        document.getElementById('profilePhone').value = profileData.phone || '';
                        document.getElementById('profileAddress').value = profileData.address || '';
                    } else {
                        showModal('No se encontraron datos de perfil.');
                    }
                } catch (error) {
                    console.error("Error fetching profile data:", error);
                    showModal(`Error al cargar datos del perfil: ${error.message}`);
                } finally {
                    hideLoading();
                }
            } else {
                showModal('Inicia sesión para ver tu perfil.');
                showContentSection(loginSection);
            }
        }

        async function showAdminSection() {
            console.log('Showing admin section...');
            if (authService.currentUser && authService.currentUser.isAdmin) {
                showLoading();
                adminSection.style.display = 'flex'; // Use flex to stack children vertically
                // Load global discount and social media links
                try {
                    const configDoc = await firestoreService.getDoc('appConfig/settings');
                    if (configDoc.exists()) {
                        const config = configDoc.data();
                        mockAppConfig = { ...mockAppConfig, ...config }; // Ensure mockAppConfig is fully updated

                        globalDiscountInput.value = config.globalDiscount || 0;
                        currentDiscountDisplay.textContent = `${config.globalDiscount || 0}%`;

                        // Load social media links
                        socialFacebookInput.value = config.socialMediaLinks.facebook || '';
                        socialInstagramInput.value = config.socialMediaLinks.instagram || '';
                        socialTwitterInput.value = config.socialMediaLinks.twitter || '';
                        socialTiktokInput.value = config.socialMediaLinks.tiktok || '';
                        socialWhatsappInput.value = config.socialMediaLinks.whatsapp || ''; // Load WhatsApp URL

                        // Load mission and vision text
                        missionVisionTextarea.value = config.missionVisionText || '';

                        // Load header background settings
                        const headerBg = config.headerBackground || { type: 'color', value: '#f9fafb', positionX: 50, positionY: 50 };
                        if (headerBg.type === 'color') {
                            headerBgColorRadio.checked = true;
                            headerBgImageRadio.checked = false;
                            headerBgColorOptions.style.display = 'block';
                            headerBgImageOptions.style.display = 'none';
                            headerBgColorInput.value = headerBg.value;
                            headerBgImagePreview.innerHTML = ''; // Clear preview
                        } else if (headerBg.type === 'image') {
                            headerBgImageRadio.checked = true;
                            headerBgColorRadio.checked = false;
                            headerBgColorOptions.style.display = 'none';
                            headerBgImageOptions.style.display = 'block';
                            headerBgImagePreview.innerHTML = headerBg.value ? `<img src="${headerBg.value}" class="w-32 h-32 object-cover rounded-md mt-2" alt="Preview de imagen de fondo">` : '';
                            headerBgColorInput.value = '#000000'; // Reset color picker
                        }
                        applyHeaderBackground(headerBg.type, headerBg.value, headerBg.positionX, headerBg.positionY); // Apply loaded background
                    }
                } catch (error) {
                    console.error("Error loading admin config:", error);
                    showModal("Error al cargar la configuración del administrador.");
                } finally {
                    hideLoading();
                }
                // Reset product accessories list
                productAccessories = [];
                renderAccessoriesList();
                // Reset product sizes list
                productSizes = [];
                renderAddedSizesList();
                // Reset product colors and images list
                productColorImageSets = [];
                renderAddedColorsAndImagesList();
                colorNameInput.value = '';
                colorPickerInput.value = '#000000'; // Reset color picker to black
                colorImageUploadInput.value = '';
                currentImagesForColor = [];
                colorImagePreviewContainer.innerHTML = '';
                noColorImagesText.style.display = 'block';

                addProductForm.reset();
                renderAdminProductList(); // Render list of products for admin
                // Initial state for size container based on default category
                toggleProductSizesContainer();
            } else {
                showModal('Acceso denegado. Solo administradores pueden ver esta sección.');
                showContentSection(loginSection);
            }
        }

        // --- ADMIN SECTION LOGIC ---

        // Global Discount Form
        discountForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Discount form submitted');
            const newGlobalDiscount = parseInt(globalDiscountInput.value, 10);
            if (isNaN(newGlobalDiscount) || newGlobalDiscount < 0 || newGlobalDiscount > 100) {
                showModal('Porcentaje de descuento global inválido (0-100).');
                return;
            }
            try {
                showLoading();
                // Fetch current settings to merge, especially social media links
                const currentSettings = (await firestoreService.getDoc('appConfig/settings')).data() || {};
                await firestoreService.setDoc('appConfig/settings', { ...currentSettings, globalDiscount: newGlobalDiscount });
                showModal('Descuento global guardado con éxito.');
                currentDiscountDisplay.textContent = `${newGlobalDiscount}%`;
                // Re-render products to apply new discount
                applyFilters();
            } catch (error) {
                console.error("Error saving global discount:", error);
                showModal(`Error al guardar descuento global: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        // Admin Credentials Form
        adminCredentialsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Admin credentials form submitted');
            const currentPassword = adminCurrentPasswordInput.value;
            const newUsername = adminNewUsernameInput.value.trim();
            const newPassword = adminNewPasswordInput.value;
            const confirmNewPassword = adminConfirmNewPasswordInput.value;

            if (newPassword && newPassword !== confirmNewPassword) {
                showModal('Las nuevas contraseñas no coinciden.');
                return;
            }

            try {
                showLoading();
                // Check if current user is admin
                if (!authService.currentUser || !authService.currentUser.isAdmin) {
                    throw new Error("auth/permission-denied");
                }

                let changesMade = false;

                if (newPassword) {
                    await authService.updatePassword(currentPassword, newPassword);
                    changesMade = true;
                }
                if (newUsername && newUsername !== authService.currentUser.email) {
                    await authService.updateEmail(authService.currentUser.email, newUsername, currentPassword);
                    changesMade = true;
                    showModal('Nombre de usuario (email) del administrador actualizado con éxito. Por favor, inicia sesión con el nuevo usuario.');
                    await authService.signOut(); // Force re-login with new email
                    return; // Exit to prevent further actions on potentially changed user
                }

                if (changesMade) {
                    showModal('Credenciales de administrador actualizadas con éxito.');
                } else {
                    showModal('No hay cambios que guardar.');
                }
                adminCredentialsForm.reset();
            } catch (error) {
                let errorMessage = 'Error al actualizar credenciales de admin.';
                if (error.message.includes('auth/wrong-password')) {
                    errorMessage = 'La contraseña actual es incorrecta.';
                } else if (error.message.includes('auth/email-already-in-use')) {
                    errorMessage = 'El nuevo email ya está en uso.';
                } else {
                    errorMessage = `Error: ${error.message}`;
                }
                showModal(errorMessage);
            } finally {
                hideLoading();
            }
        });

        // Social Media Form
        socialMediaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Social media form submitted');
            const socialLinks = {
                facebook: socialFacebookInput.value,
                instagram: socialInstagramInput.value,
                twitter: socialTwitterInput.value,
                tiktok: socialTiktokInput.value,
                whatsapp: socialWhatsappInput.value // Save WhatsApp URL
            };

            try {
                showLoading();
                // Fetch current settings to merge global discount
                const currentSettings = (await firestoreService.getDoc('appConfig/settings')).data() || {};
                await firestoreService.setDoc('appConfig/settings', { ...currentSettings, socialMediaLinks: socialLinks });
                showModal('Enlaces de redes sociales guardados con éxito.');
                updateFooterSocialLinks(); // Update the footer immediately
                updateWhatsappFloatButton(); // Update the floating button
            } catch (error) {
                console.error("Error saving social media links:", error);
                showModal(`Error al guardar enlaces de redes sociales: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        // Function to update footer social media links
        function updateFooterSocialLinks() {
            const links = mockAppConfig.socialMediaLinks;
            facebookLink.href = links.facebook || '#';
            instagramLink.href = links.instagram || '#';
            twitterLink.href = links.twitter || '#';
            tiktokLink.href = links.tiktok || '#';

            // Show/hide icons based on whether a URL is provided
            facebookLink.style.display = links.facebook ? 'inline-block' : 'none';
            instagramLink.style.display = links.instagram ? 'inline-block' : 'none';
            twitterLink.style.display = links.twitter ? 'inline-block' : 'none';
            tiktokLink.style.display = links.tiktok ? 'inline-block' : 'none';
        }

        // Function to update WhatsApp floating button
        function updateWhatsappFloatButton() {
            const whatsappUrl = mockAppConfig.socialMediaLinks.whatsapp;
            if (whatsappUrl) {
                whatsappFloatBtn.href = whatsappUrl;
                whatsappFloatBtn.style.display = 'flex'; // Show button
            } else {
                whatsappFloatBtn.style.display = 'none'; // Hide button
            }
        }

        // Mission and Vision Form
        missionVisionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Mission and Vision form submitted');
            const newMissionVisionText = missionVisionTextarea.value.trim();

            try {
                showLoading();
                const currentSettings = (await firestoreService.getDoc('appConfig/settings')).data() || {};
                await firestoreService.setDoc('appConfig/settings', { ...currentSettings, missionVisionText: newMissionVisionText });
                showModal('Misión y Visión guardada con éxito.');
                updateMissionVisionDisplay(); // Update the footer display
            } catch (error) {
                console.error("Error saving mission and vision:", error);
                showModal(`Error al guardar Misión y Visión: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        // Function to update Mission and Vision display in the footer
        function updateMissionVisionDisplay() {
            missionVisionTextElement.textContent = mockAppConfig.missionVisionText || 'No se ha configurado la misión y visión.';
        }

        // New: Header Background Form Logic
        headerBgColorRadio.addEventListener('change', () => {
            headerBgColorOptions.style.display = 'block';
            headerBgImageOptions.style.display = 'none';
            // When switching to color, disable editing mode
            isHeaderBackgroundEditingMode = false;
            mainHeader.classList.remove('editing-mode');
        });

        headerBgImageRadio.addEventListener('change', () => {
            headerBgColorOptions.style.display = 'none';
            headerBgImageOptions.style.display = 'block';
            // When switching to image, ensure editing mode is off by default until preview is clicked
            isHeaderBackgroundEditingMode = false;
            mainHeader.classList.remove('editing-mode');
        });

        headerBgImageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    headerBgImagePreview.innerHTML = `<img src="${event.target.result}" class="w-32 h-32 object-cover rounded-md mt-2" alt="Preview de imagen de fondo">`;
                    // When a new image is selected, apply it immediately for preview
                    applyHeaderBackground('image', event.target.result, mockAppConfig.headerBackground.positionX, mockAppConfig.headerBackground.positionY);
                    // Do NOT enable editing mode automatically, wait for "Preview" button
                    isHeaderBackgroundEditingMode = false;
                    mainHeader.classList.remove('editing-mode');
                };
                reader.readAsDataURL(file);
            } else {
                headerBgImagePreview.innerHTML = '';
                // If no file selected, revert to previous background or default
                applyHeaderBackground(mockAppConfig.headerBackground.type, mockAppConfig.headerBackground.value, mockAppConfig.headerBackground.positionX, mockAppConfig.headerBackground.positionY);
                isHeaderBackgroundEditingMode = false;
                mainHeader.classList.remove('editing-mode');
            }
        });

        // "Vista Previa" button logic
        previewHeaderBgBtn.addEventListener('click', () => {
            // Only enable preview/dragging if the type is image and an image is set
            if (headerBgImageRadio.checked && (headerBgImageUpload.files[0] || mockAppConfig.headerBackground.value)) {
                isHeaderBackgroundEditingMode = true;
                mainHeader.classList.add('editing-mode');
                showModal('Modo de vista previa activado. Ahora puedes arrastrar la imagen de la cabecera.');
            } else if (headerBgColorRadio.checked) {
                showModal('No se puede arrastrar un fondo de color. Cambia a "Imagen" para usar esta función.');
            } else {
                showModal('Por favor, selecciona o sube una imagen de fondo primero.');
            }
        });

        // "Guardar Cambios" button logic
        saveHeaderBgBtn.addEventListener('click', async () => {
            console.log('Save Header Background Changes button clicked');
            let backgroundType;
            let backgroundValue;
            let positionX = mockAppConfig.headerBackground.positionX; // Keep current position
            let positionY = mockAppConfig.headerBackground.positionY; // Keep current position

            if (headerBgColorRadio.checked) {
                backgroundType = 'color';
                backgroundValue = headerBgColorInput.value;
            } else {
                backgroundType = 'image';
                const file = headerBgImageUpload.files[0];
                if (file) {
                    try {
                        showLoading();
                        const uploadedImage = await storageService.uploadFile(file, `header_backgrounds/${file.name}`);
                        backgroundValue = uploadedImage.downloadURL;
                        // If a new image is uploaded, reset position to center
                        positionX = 50;
                        positionY = 50;
                    } catch (error) {
                        console.error("Error uploading background image:", error);
                        showModal(`Error al subir imagen de fondo: ${error.message}`);
                        hideLoading();
                        return;
                    }
                } else {
                    // If no new image is uploaded, retain existing image if any
                    backgroundValue = mockAppConfig.headerBackground.type === 'image' ? mockAppConfig.headerBackground.value : '';
                    // Position X and Y are already from mockAppConfig, so no change needed here if no new file.
                }
            }

            try {
                showLoading();
                const currentSettings = (await firestoreService.getDoc('appConfig/settings')).data() || {};
                await firestoreService.setDoc('appConfig/settings', {
                    ...currentSettings,
                    headerBackground: {
                        type: backgroundType,
                        value: backgroundValue,
                        positionX: positionX, // Save the position
                        positionY: positionY  // Save the position
                    }
                });
                // Apply the background with the saved position
                applyHeaderBackground(backgroundType, backgroundValue, positionX, positionY);
                showModal('Fondo de la cabecera guardado con éxito.');
                // After saving, disable editing mode
                isHeaderBackgroundEditingMode = false;
                mainHeader.classList.remove('editing-mode');
            } catch (error) {
                console.error("Error saving header background:", error);
                showModal(`Error al guardar el fondo de la cabecera: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        function applyHeaderBackground(type, value, positionX = 50, positionY = 50) {
            mainHeader.classList.remove('bg-color', 'bg-image');
            mainHeader.style.backgroundColor = '';
            mainHeader.style.backgroundImage = '';
            mainHeader.style.backgroundPosition = ''; // Clear previous position

            if (type === 'color') {
                mainHeader.classList.add('bg-color');
                mainHeader.style.backgroundColor = value; // Set directly
            } else if (type === 'image') {
                mainHeader.classList.add('bg-image');
                mainHeader.style.setProperty('--header-bg-image', `url('${value}')`);
                mainHeader.style.setProperty('--header-bg-position-x', `${positionX}%`); // Set CSS variable
                mainHeader.style.setProperty('--header-bg-position-y', `${positionY}%`); // Set CSS variable
            }
        }

        // Add Product Form - Image Handling (now for colors)
        selectColorImagesBtn.addEventListener('click', () => {
            colorImageUploadInput.click(); // Trigger the hidden file input
        });

        colorImageUploadInput.addEventListener('change', (e) => {
            console.log('Color image upload changed');
            colorImagePreviewContainer.innerHTML = ''; // Clear previous previews
            currentImagesForColor = []; // Reset for new selection

            const files = Array.from(e.target.files);
            if (files.length > 0) {
                noColorImagesText.style.display = 'none';
            } else {
                noColorImagesText.style.display = 'block';
            }

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('w-24', 'h-24', 'object-cover', 'rounded-md', 'border', 'border-gray-300');
                    colorImagePreviewContainer.appendChild(img);
                    currentImagesForColor.push(e.target.result); // Store Data URL
                };
                reader.readAsDataURL(file);
            });
        });

        // New: Event listener for color picker input
        colorPickerInput.addEventListener('input', (e) => {
            colorNameInput.value = e.target.value.toUpperCase(); // Set text input to hex code
        });


        addColorsAndImagesBtn.addEventListener('click', () => {
            console.log('Add Color with Images button clicked');
            const colorName = colorNameInput.value.trim();

            if (!colorName) {
                showModal("Por favor, introduce un nombre para el color.");
                return;
            }
            if (currentImagesForColor.length === 0) {
                showModal("Por favor, selecciona al menos una imagen para este color.");
                return;
            }
            if (productColorImageSets.some(set => set.color.toLowerCase() === colorName.toLowerCase())) {
                showModal(`El color "${colorName}" ya ha sido añadido.`);
                return;
            }

            productColorImageSets.push({ color: colorName, urls: [...currentImagesForColor] });
            renderAddedColorsAndImagesList();

            // Reset inputs for next color
            colorNameInput.value = '';
            colorPickerInput.value = '#000000'; // Reset color picker to black
            colorImageUploadInput.value = ''; // Clear file input
            currentImagesForColor = [];
            colorImagePreviewContainer.innerHTML = '';
            noColorImagesText.style.display = 'block';
        });

        function renderAddedColorsAndImagesList() {
            addedColorsAndImagesList.innerHTML = '';
            if (productColorImageSets.length === 0) {
                noColorsAddedText.style.display = 'block';
            } else {
                noColorsAddedText.style.display = 'none';
                productColorImageSets.forEach((colorSet, index) => {
                    const div = document.createElement('div');
                    div.classList.add('p-2', 'border', 'rounded-md', 'bg-white', 'flex', 'items-start', 'gap-2', 'mb-2');
                    
                    let thumbnailsHtml = colorSet.urls.map(url => `
                        <img src="${url}" class="w-16 h-16 object-cover rounded-sm border" alt="Imagen de ${colorSet.color}">
                    `).join('');

                    div.innerHTML = `
                        <div class="flex-grow">
                            <h5 class="font-semibold text-pink-600">${colorSet.color}</h5>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${thumbnailsHtml}
                            </div>
                        </div>
                        <button type="button" class="text-red-500 hover:text-red-700 text-lg" data-index="${index}">&times;</button>
                    `;
                    div.querySelector('button').addEventListener('click', (e) => {
                        const indexToRemove = parseInt(e.target.dataset.index);
                        productColorImageSets.splice(indexToRemove, 1);
                        renderAddedColorsAndImagesList();
                    });
                    addedColorsAndImagesList.appendChild(div);
                });
            }
        }

        // Add Product Form - Accessory Handling (existing)
        let productAccessories = [];

        addAccessoryBtn.addEventListener('click', () => {
            console.log('Add accessory button clicked');
            const accessoryName = accessoryNameInput.value.trim();
            if (accessoryName) {
                productAccessories.push(accessoryName);
                renderAccessoriesList();
                accessoryNameInput.value = '';
                noAccessoriesText.style.display = 'none';
            } else {
                showModal("Por favor, introduce el nombre del accesorio.");
            }
        });

        function renderAccessoriesList() {
            accessoriesListContainer.innerHTML = '';
            if (productAccessories.length === 0) {
                noAccessoriesText.style.display = 'block';
            } else {
                noAccessoriesText.style.display = 'none';
                productAccessories.forEach((accessory, index) => {
                    const div = document.createElement('div');
                    div.classList.add('accessory-item'); // Reusing accessory-item style for consistency
                    div.innerHTML = `
                        <span>${accessory}</span>
                        <button type="button" data-index="${index}">&times;</button>
                    `;
                    div.querySelector('button').addEventListener('click', (e) => {
                        const indexToRemove = parseInt(e.target.dataset.index);
                        productAccessories.splice(indexToRemove, 1);
                        renderAccessoriesList();
                    });
                    accessoriesListContainer.appendChild(div);
                });
            }
        }

        // New: Product Sizes Admin Handling (existing)
        addSizeBtn.addEventListener('click', () => {
            console.log('Add size button clicked');
            const selectedSize = sizeSelector.value;
            if (selectedSize && !productSizes.includes(selectedSize)) {
                productSizes.push(selectedSize);
                renderAddedSizesList();
                sizeSelector.value = ''; // Reset selector
                noSizesText.style.display = 'none';
            } else if (productSizes.includes(selectedSize)) {
                showModal(`La talla "${selectedSize}" ya ha sido añadida.`);
            } else {
                showModal("Por favor, selecciona una talla.");
            }
        });

        function renderAddedSizesList() {
            addedSizesList.innerHTML = '';
            if (productSizes.length === 0) {
                noSizesText.style.display = 'block';
            } else {
                noSizesText.style.display = 'none';
                productSizes.forEach((size, index) => {
                    const div = document.createElement('div');
                    div.classList.add('accessory-item'); // Reusing accessory-item style for consistency
                    div.innerHTML = `
                        <span>${size}</span>
                        <button type="button" data-index="${index}">&times;</button>
                    `;
                    div.querySelector('button').addEventListener('click', (e) => {
                        const indexToRemove = parseInt(e.target.dataset.index);
                        productSizes.splice(indexToRemove, 1);
                        renderAddedSizesList();
                    });
                    accessoriesListContainer.appendChild(div);
                });
            }
        }

        // Toggle visibility of size input based on category (existing)
        productCategorySelect.addEventListener('change', toggleProductSizesContainer);

        function toggleProductSizesContainer() {
            if (productCategorySelect.value === 'Boutique') {
                productSizesContainer.style.display = 'block';
            } else {
                productSizesContainer.style.display = 'none';
                productSizes = []; // Clear sizes if category changes from Boutique
                renderAddedSizesList();
            }
        }


        // Add Product Form Submission
        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Add product form submitted');

            const name = productNameInput.value;
            const description = productDescriptionTextarea.value;
            const price = parseFloat(productPriceInput.value);
            const stock = parseInt(productStockInput.value, 10); // Get stock
            const category = productCategorySelect.value;
            const individualDiscount = parseInt(productIndividualDiscountInput.value, 10);

            // Validation for imageSets based on category
            if (category === 'Boutique' && productColorImageSets.length === 0) {
                showModal('Para productos de Boutique, por favor añade al menos un color con sus imágenes.');
                return;
            }
            if (category === 'Make Up' && (productColorImageSets.length === 0 || productColorImageSets[0].color.toLowerCase() !== 'default' || productColorImageSets[0].urls.length === 0)) {
                showModal('Para productos de Make Up, por favor añade un color "Default" con sus imágenes.');
                return;
            }


            if (isNaN(price) || price <= 0) {
                showModal('Por favor, ingresa un precio válido y positivo para el producto.');
                return;
            }
            if (isNaN(stock) || stock < 0) {
                showModal('Por favor, ingresa un stock válido (número entero no negativo).');
                return;
            }
            if (isNaN(individualDiscount) || individualDiscount < 0 || individualDiscount > 100) {
                showModal('Porcentaje de descuento individual inválido (0-100).');
                return;
            }
            // Check for sizes if category is Boutique
            if (category === 'Boutique' && productSizes.length === 0) {
                showModal('Por favor, añade al menos una talla para productos de Boutique.');
                return;
            }


            try {
                showLoading();
                const newProduct = {
                    name,
                    description,
                    price,
                    stock, // Include stock
                    category,
                    imageSets: productColorImageSets, // Use the new structure
                    accessories: productAccessories,
                    sizes: category === 'Boutique' ? productSizes : [], // Include sizes only for Boutique
                    discountPercentage: individualDiscount // Store individual discount
                };

                await firestoreService.addDoc('products', newProduct);
                showModal('Producto añadido con éxito.');
                addProductForm.reset();
                productAccessories = [];
                renderAccessoriesList();
                productSizes = [];
                renderAddedSizesList();
                productColorImageSets = []; // Clear color image sets
                renderAddedColorsAndImagesList(); // Re-render the list
                noColorImagesText.style.display = 'block'; // Reset text
                colorNameInput.value = ''; // Clear color name input
                colorPickerInput.value = '#000000'; // Reset color picker to black
                colorImageUploadInput.value = ''; // Clear file input
                currentImagesForColor = [];
                colorImagePreviewContainer.innerHTML = ''; // Clear previews
                
                toggleProductSizesContainer(); // Reset visibility based on default category
                renderAdminProductList(); // Update admin product list
                applyFilters(); // Re-render products to show the new product
            } catch (error) {
                console.error("Error adding product:", error);
                showModal(`Error al añadir producto: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        // Gemini AI for description generation (existing)
        generateDescBtn.addEventListener('click', async () => {
            console.log('Generate description button clicked');
            const baseDescription = productDescriptionTextarea.value.trim();
            if (!baseDescription) {
                showModal('Por favor, escribe una descripción base antes de generar una mejorada.');
                return;
            }

            descLoadingSpinner.style.display = 'inline-block';
            generateDescBtn.disabled = true;

            try {
                // In a real scenario, you'd send this to a backend that calls the Gemini API
                // For this mock, we'll simulate a response.
                const prompt = `Mejora y expande la siguiente descripción de producto para una tienda de boutique/maquillaje en línea, haciéndola más atractiva y detallada, enfocándote en beneficios y estilo. Mantén un tono elegante y conciso. Descripción base: "${baseDescription}"`;

                console.log("Simulating Gemini API call with prompt:", prompt);

                // Simulate API call delay
                await new Promise(resolve => setTimeout(() => {
                    const simulatedResponse = `✨ Presentamos nuestro "${productNameInput.value || 'Producto Soñado'}" ✨. Una pieza exquisita diseñada para [mencionar beneficio clave de la base, ej: elevar tu estilo, realzar tu belleza]. Con su [mencionar característica clave de la base, ej: tejido delicado, pigmentación intensa], este [producto] no solo es [cualidad, ej: elegante, vibrante] sino también [otra cualidad, ej: increíblemente cómodo, de larga duración]. Ideal para [ocasión/uso, ej: cualquier evento especial, tu rutina diaria de belleza]. Descubre la perfección en cada detalle y hazlo tuyo hoy.`;
                    productDescriptionTextarea.value = simulatedResponse;
                    resolve();
                }, Math.random() * 1000 + 500));

                showModal('Descripción mejorada generada por IA.');
            } catch (error) {
                console.error("Error generating description with Gemini mock:", error);
                showModal('Error al generar la descripción. Por favor, inténtalo de nuevo.');
            } finally {
                descLoadingSpinner.style.display = 'none';
                generateDescBtn.disabled = false;
            }
        });

        // Admin Product List Rendering and Deletion (updated to show colors)
        async function renderAdminProductList() {
            console.log('Rendering admin product list...');
            adminProductList.innerHTML = '<p class="text-gray-500 text-center">Cargando productos...</p>';
            try {
                const products = await firestoreService.getDocs('products');
                if (products.length === 0) {
                    adminProductList.innerHTML = '<p class="text-gray-500 text-center">No hay productos para gestionar.</p>';
                } else {
                    let productsHtml = '';
                    products.forEach(productDoc => {
                        const product = productDoc.data();
                        // Get the first image from the first color set for thumbnail
                        const thumbnailUrl = product.imageSets && product.imageSets.length > 0 && product.imageSets[0].urls.length > 0
                            ? product.imageSets[0].urls[0]
                            : 'https://placehold.co/50x50/cccccc/333333?text=No+Image';

                        // Display colors
                        const colorsDisplay = product.imageSets && product.imageSets.length > 0
                            ? product.imageSets.map(cs => cs.color).join(', ')
                            : 'N/A';

                        productsHtml += `
                            <div class="admin-product-item">
                                <img src="${thumbnailUrl}" alt="${product.name}">
                                <div class="admin-product-item-info">
                                    <h4>${product.name}</h4>
                                    <p>Stock: ${product.stock} | Precio: $${product.price.toFixed(2)}</p>
                                    ${product.sizes && product.sizes.length > 0 ? `<p class="text-xs text-gray-500">Tallas: ${product.sizes.join(', ')}</p>` : ''}
                                    <p class="text-xs text-gray-500">Colores: ${colorsDisplay}</p>
                                </div>
                                <button class="delete-product-btn" data-product-id="${product.id}">Eliminar</button>
                            </div>
                        `;
                    });
                    adminProductList.innerHTML = productsHtml;

                    // Attach delete listeners
                    document.querySelectorAll('.delete-product-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const productId = e.target.dataset.productId;
                            if (confirm('¿Estás seguro de que quieres eliminar este producto?')) { // Using confirm for simplicity, replace with custom modal in real app
                                try {
                                    showLoading();
                                    await firestoreService.deleteDoc(`products/${productId}`);
                                    showModal('Producto eliminado con éxito.');
                                    renderAdminProductList(); // Re-render list
                                    applyFilters(); // Re-render main product view
                                } catch (error) {
                                    console.error("Error deleting product:", error);
                                    showModal(`Error al eliminar producto: ${error.message}`);
                                } finally {
                                    hideLoading();
                                }
                            }
                        });
                    });
                }
            } catch (error) {
                console.error("Error loading admin product list:", error);
                adminProductList.innerHTML = `<p class="text-red-500 text-center">Error al cargar productos: ${error.message}</p>`;
            }
        }


        // --- CART & FAVORITES RENDERING ---
        async function renderCart() {
            console.log('Rendering cart...');
            showLoading();
            const cartItemsContainer = document.getElementById('cartItemsContainer');
            const checkoutBtn = document.getElementById('checkoutBtn');
            const userId = authService.currentUser.uid;

            try {
                const cartDocs = await firestoreService.getDocs(`users/${userId}/cart`);
                const cartItems = cartDocs.map(doc => doc.data());
                let totalCartPrice = 0;

                if (cartItems.length === 0) {
                    cartItemsContainer.innerHTML = '<p class="text-gray-500">Tu carrito está vacío.</p>';
                    checkoutBtn.style.display = 'none';
                } else {
                    let itemsHtml = '';
                    for (const item of cartItems) {
                        const product = mockProducts.find(p => p.id === item.productId);
                        if (!product) continue;

                        const { price: discountedPrice, percentage: discountPercentage } = calculatePriceWithDiscount(product.price, product.discountPercentage);
                        const itemTotal = parseFloat(discountedPrice) * item.quantity;
                        totalCartPrice += itemTotal;

                        // Determine the image for the cart item based on selected color
                        let itemImageUrl = 'https://placehold.co/100x100/cccccc/333333?text=No+Image';
                        if (product.imageSets && product.imageSets.length > 0) {
                            const colorSet = product.imageSets.find(set => set.color === item.selectedColor);
                            if (colorSet && colorSet.urls.length > 0) {
                                itemImageUrl = colorSet.urls[0];
                            } else if (product.imageSets[0].urls.length > 0) {
                                itemImageUrl = product.imageSets[0].urls[0]; // Fallback to first image of first set
                            }
                        }

                        itemsHtml += `
                            <div class="flex items-center justify-between border-b py-4 last:border-b-0">
                                <div class="flex items-center">
                                    <img src="${itemImageUrl}" alt="${product.name}" class="w-16 h-16 object-cover rounded mr-4">
                                    <div>
                                        <h4 class="font-semibold">${product.name}</h4>
                                        <p class="text-gray-600 text-sm">Cantidad: ${item.quantity} ${item.selectedSize ? `(Talla: ${item.selectedSize})` : ''} ${item.selectedColor ? `(Color: ${item.selectedColor})` : ''}</p>
                                        <p class="text-gray-800 font-bold">$${itemTotal.toFixed(2)}</p>
                                        ${discountPercentage > 0 ? `<p class="text-sm text-gray-500 line-through">$${(product.price * item.quantity).toFixed(2)}</p>` : ''}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="update-quantity-btn btn-secondary text-sm py-1 px-2" data-product-id="${product.id}" data-action="decrease" data-size="${item.selectedSize || ''}" data-color="${item.selectedColor || ''}">-</button>
                                    <span class="font-bold">${item.quantity}</span>
                                    <button class="update-quantity-btn btn-secondary text-sm py-1 px-2" data-product-id="${product.id}" data-action="increase" data-size="${item.selectedSize || ''}" data-color="${item.selectedColor || ''}">+</button>
                                    <button class="text-red-500 hover:text-red-700 ml-4 remove-from-cart-btn" data-product-id="${product.id}" data-size="${item.selectedSize || ''}" data-color="${item.selectedColor || ''}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    cartItemsContainer.innerHTML = itemsHtml + `<div class="text-right mt-4 text-xl font-bold">Total: $${totalCartPrice.toFixed(2)}</div>`;
                    checkoutBtn.style.display = 'block';
                }

                document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const productId = e.currentTarget.dataset.productId;
                        const size = e.currentTarget.dataset.size || null;
                        const color = e.currentTarget.dataset.color || null; // Get color
                        console.log('Remove from cart clicked for:', productId, 'size:', size, 'color:', color);
                        try {
                            showLoading();
                            const cartToUpdate = mockUserCarts[userId];
                            if (cartToUpdate) {
                                const itemIndex = cartToUpdate.findIndex(item =>
                                    item.productId === productId &&
                                    (item.selectedSize === size || (!item.selectedSize && !size)) &&
                                    (item.selectedColor === color || (!item.selectedColor && !color))
                                );
                                if (itemIndex > -1) {
                                    const itemToRemove = cartToUpdate[itemIndex];
                                    const product = mockProducts.find(p => p.id === itemToRemove.productId);
                                    if (product) {
                                        product.stock += itemToRemove.quantity; // Return stock
                                        firestoreService._notifyListeners('products'); // Notify products to update stock display
                                    }
                                    cartToUpdate.splice(itemIndex, 1);
                                }
                            }
                            firestoreService._notifyListeners(`users/${userId}/cart`); // Manually trigger update
                            showModal('Producto eliminado del carrito.');
                            renderCart(); // Re-render cart
                            applyFilters(); // Re-render products to update stock display
                        } catch (error) {
                            console.error("Error removing from cart:", error);
                            showModal(`Error al eliminar producto del carrito: ${error.message}`);
                        } finally {
                            hideLoading();
                        }
                    });
                });

                 document.querySelectorAll('.update-quantity-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const productId = e.currentTarget.dataset.productId;
                        const action = e.currentTarget.dataset.action;
                        const size = e.currentTarget.dataset.size || null;
                        const color = e.currentTarget.dataset.color || null; // Get color
                        console.log(`Update quantity clicked for ${productId}, action: ${action}, size: ${size}, color: ${color}`);
                        
                        const userId = authService.currentUser.uid;
                        const cart = mockUserCarts[userId];
                        if (!cart) return;

                        const currentItemIndex = cart.findIndex(item =>
                            item.productId === productId &&
                            (item.selectedSize === size || (!item.selectedSize && !size)) &&
                            (item.selectedColor === color || (!item.selectedColor && !color))
                        );
                        
                        if (currentItemIndex > -1) {
                            const currentItem = cart[currentItemIndex];
                            let newQuantity = currentItem.quantity;
                            const product = mockProducts.find(p => p.id === productId);

                            if (action === 'increase') {
                                newQuantity++;
                            } else if (action === 'decrease' && newQuantity > 1) {
                                newQuantity--;
                            } else if (action === 'decrease' && newQuantity === 1) {
                                // If quantity is 1 and decreasing, remove the item
                                try {
                                    if (product) {
                                        product.stock += currentItem.quantity; // Return stock
                                        firestoreService._notifyListeners('products');
                                    }
                                    cart.splice(currentItemIndex, 1);
                                    firestoreService._notifyListeners(`users/${userId}/cart`);
                                    showModal('Producto eliminado del carrito.');
                                    renderCart();
                                    applyFilters();
                                    return;
                                } catch (error) {
                                    showModal(`Error al eliminar producto: ${error.message}`);
                                    return;
                                }
                            }
                            try {
                                const quantityChange = newQuantity - currentItem.quantity;
                                if (product && product.stock < quantityChange) {
                                    throw new Error("Not enough stock for this quantity change.");
                                }
                                if (product) {
                                    product.stock -= quantityChange;
                                    firestoreService._notifyListeners('products');
                                }
                                currentItem.quantity = newQuantity;
                                firestoreService._notifyListeners(`users/${userId}/cart`);
                                renderCart();
                                applyFilters();
                            } catch (error) {
                                showModal(`Error al actualizar cantidad: ${error.message}`);
                            }
                        }
                    });
                });

                checkoutBtn.addEventListener('click', () => {
                    showModal('Procesando pago... (Funcionalidad de pago no implementada en este demo)');
                });

            } catch (error) {
                console.error("Error rendering cart:", error);
                showModal(`Error al cargar el carrito: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function renderFavorites() {
            console.log('Rendering favorites...');
            showLoading();
            const favoritesContainer = document.getElementById('favoritesContainer');
            const userId = authService.currentUser.uid;

            try {
                const favoriteDocs = await firestoreService.getDocs(`users/${userId}/favorites`);
                const favoriteProductIds = favoriteDocs.map(doc => doc.data().productId);

                if (favoriteProductIds.length === 0) {
                    favoritesContainer.innerHTML = '<p class="col-span-full text-center text-gray-500 text-lg">No tienes productos en favoritos.</p>';
                } else {
                    let productsHtml = '';
                    for (const productId of favoriteProductIds) {
                        const product = mockProducts.find(p => p.id === productId);
                        if (!product) continue;

                        const { price: discountedPrice, percentage: discountPercentage } = calculatePriceWithDiscount(product.price, product.discountPercentage);
                        const isOutOfStock = product.stock <= 0;
                        const stockText = isOutOfStock ? '<span class="text-red-500 font-bold">Agotado</span>' : `<span class="text-green-600">En Stock (${product.stock})</span>`;
                        const addToCartDisabled = isOutOfStock ? 'disabled' : '';
                        const addToCartClass = isOutOfStock ? 'opacity-50 cursor-not-allowed' : '';

                        // Get the first image from the first color set for the product card thumbnail
                        const thumbnailSrc = product.imageSets && product.imageSets.length > 0 && product.imageSets[0].urls.length > 0
                            ? product.imageSets[0].urls[0]
                            : 'https://placehold.co/400x300/cccccc/333333?text=No+Image';

                        productsHtml += `
                            <div class="product-card" data-product-id="${product.id}">
                                <img src="${thumbnailSrc}" alt="${product.name}">
                                <div class="product-card-content">
                                    <h3 class="text-lg font-semibold text-gray-900">${product.name}</h3>
                                    <div class="flex items-baseline mb-2">
                        `;
                        if (discountPercentage > 0) {
                            productsHtml += `
                                        <span class="text-gray-500 line-through mr-2">$${product.price.toFixed(2)}</span>
                                        <span class="text-red-600 font-bold text-xl">$${discountedPrice}</span>
                                        <span class="discount-badge">-${discountPercentage}%</span>
                            `;
                        } else {
                            productsHtml += `<span class="text-gray-900 font-bold text-xl">$${product.price.toFixed(2)}</span>`;
                        }

                        productsHtml += `
                                    </div>
                                    <p class="text-sm font-semibold text-gray-700">${stockText}</p>
                                    <p class="text-gray-600 text-sm mb-4 line-clamp-3">${product.description}</p>
                                    <div class="product-card-actions flex justify-between items-center">
                                        <button class="btn-primary text-sm add-to-cart-btn ${addToCartClass}" data-product-id="${product.id}" ${addToCartDisabled}>
                                            <i class="fas fa-shopping-cart mr-2"></i> Añadir
                                        </button>
                                        <button class="favorite-btn text-pink-500 active" data-product-id="${product.id}">
                                            <i class="fas fa-heart"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    favoritesContainer.innerHTML = productsHtml;
                    attachProductCardListeners();
                    attachAddToCartListeners();
                    attachFavoriteListeners();
                }
            } catch (error) {
                console.error("Error rendering favorites:", error);
                showModal(`Error al cargar favoritos: ${error.message}`);
            } finally {
                hideLoading();
            }
        }


        async function updateFavoritesCount() {
            console.log('Updating favorites count...');
            if (authService.currentUser && !authService.currentUser.isAnonymous) {
                const userId = authService.currentUser.uid;
                try {
                    const favoriteDocs = await firestoreService.getDocs(`users/${userId}/favorites`);
                    const count = favoriteDocs.length;
                    document.getElementById('favoritesCount').textContent = count;
                    document.getElementById('favoritesCount').style.display = count > 0 ? 'flex' : 'none';
                } catch (error) {
                    console.error("Error updating favorites count:", error);
                }
            } else {
                document.getElementById('favoritesCount').textContent = '0';
                document.getElementById('favoritesCount').style.display = 'none';
            }
        }

        async function updateCartCount() {
            console.log('Updating cart count...');
            if (authService.currentUser && !authService.currentUser.isAnonymous) {
                const userId = authService.currentUser.uid;
                try {
                    const cartDocs = await firestoreService.getDocs(`users/${userId}/cart`);
                    const count = cartDocs.reduce((sum, doc) => sum + doc.data().quantity, 0);
                    document.getElementById('cartCount').textContent = count;
                    document.getElementById('cartCount').style.display = count > 0 ? 'flex' : 'none';
                } catch (error) {
                    console.error("Error updating cart count:", error);
                }
            } else {
                document.getElementById('cartCount').textContent = '0';
                document.getElementById('cartCount').style.display = 'none';
            }
        }

        function setActiveNav(buttonId) {
            // Remove 'nav-active' from all main nav buttons
            document.querySelectorAll('header nav button').forEach(btn => {
                btn.classList.remove('nav-active');
            });
            // Remove 'nav-active' from category slider buttons
            document.querySelectorAll('.category-slider .category-btn').forEach(btn => {
                btn.classList.remove('nav-active');
            });

            const activeButton = document.getElementById(buttonId);
            if (activeButton) {
                activeButton.classList.add('nav-active');
            }
        }

        // Function to apply current filters and re-render products
        function applyFilters() {
            const selectedCategory = categoryFilter.value;
            const currentSearchQuery = searchInput.value;
            const minPrice = parseFloat(minPriceInput.value);
            const maxPrice = parseFloat(maxPriceInput.value);
            renderProducts(selectedCategory, currentSearchQuery, minPrice, maxPrice);
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM Content Loaded. Initializing app...');
            // Set current year in footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            // Load initial app config (especially WhatsApp URL)
            try {
                const configDoc = await firestoreService.getDoc('appConfig/settings');
                if (configDoc.exists()) {
                    mockAppConfig = { ...mockAppConfig, ...configDoc.data() };
                }
            } catch (error) {
                console.error("Error loading initial app config:", error);
            }

            // Apply initial header background
            const initialHeaderBg = mockAppConfig.headerBackground || { type: 'color', value: '#f9fafb', positionX: 50, positionY: 50 };
            applyHeaderBackground(initialHeaderBg.type, initialHeaderBg.value, initialHeaderBg.positionX, initialHeaderBg.positionY);

            // Initial render of products and social media links
            applyFilters(); // Render products with initial filter state
            updateFooterSocialLinks();
            updateWhatsappFloatButton(); // Initialize WhatsApp button
            updateMissionVisionDisplay(); // Initialize Mission and Vision display
            setActiveNav('boutiqueBtn'); // Set Boutique as active initially

            // Listen for auth state changes to update UI and fetch user-specific data
            authService.onAuthStateChanged(user => {
                console.log("Auth state changed:", user);
                if (user && !user.isAnonymous) {
                    authLinks.style.display = 'none';
                    userProfileLink.style.display = 'inline-block';
                    if (user.isAdmin) {
                        adminNavBtn.style.display = 'inline-block';
                    } else {
                        adminNavBtn.style.display = 'none';
                    }
                    updateFavoritesCount();
                    updateCartCount();
                    // If the user was on a auth-related page (login, register, forgot), redirect to products
                    const currentVisibleSection = getVisibleSection();
                    if ([loginSection, registerSection, forgotPasswordSection].includes(currentVisibleSection)) {
                        showContentSection(pageContent);
                        applyFilters(); // Re-render products with current filters
                    }
                } else {
                    authLinks.style.display = 'inline-block';
                    userProfileLink.style.display = 'none';
                    adminNavBtn.style.display = 'none';
                    updateFavoritesCount(); // Reset counts for anonymous user
                    updateCartCount();
                    // If not already on login/register, show products
                    const currentVisibleSection = getVisibleSection();
                    if (![loginSection, registerSection, forgotPasswordSection].includes(currentVisibleSection)) {
                        showContentSection(pageContent);
                        applyFilters(); // Re-render products with current filters
                    }
                }
            });

            // Event Listeners for search and filter controls
            applyFiltersBtn.addEventListener('click', applyFilters);
            searchInput.addEventListener('input', applyFilters); // Live search as user types
            categoryFilter.addEventListener('change', applyFilters);

            clearFiltersBtn.addEventListener('click', () => {
                searchInput.value = '';
                categoryFilter.value = 'All';
                minPriceInput.value = '';
                maxPriceInput.value = '';
                currentCategory = 'Boutique'; // Reset currentCategory to default for navigation buttons
                applyFilters();
                setActiveNav('boutiqueBtn'); // Re-activate default category button visually
            });

            // New event listeners for expandable search/filter icons
            searchIconBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent document click from immediately closing
                hideAllExpandedControls(); // Close any other open panels
                expandedSearchContainer.style.display = expandedSearchContainer.style.display === 'block' ? 'none' : 'block';
                if (expandedSearchContainer.style.display === 'block') {
                    searchInput.focus(); // Focus on the input when opened
                }
            });

            filterIconBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent document click from immediately closing
                hideAllExpandedControls(); // Close any other open panels
                expandedFilterContainer.style.display = expandedFilterContainer.style.display === 'block' ? 'none' : 'block';
            });

            closeSearchBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                expandedSearchContainer.style.display = 'none';
            });

            closeFilterBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                expandedFilterContainer.style.display = 'none';
            });

            // Close expanded controls if clicked outside
            window.addEventListener('click', (event) => {
                // Check if the click is outside the search container or filter container
                const isClickInsideSearch = expandedSearchContainer.contains(event.target) || searchIconBtn.contains(event.target);
                const isClickInsideFilter = expandedFilterContainer.contains(event.target) || filterIconBtn.contains(event.target);

                if (!isClickInsideSearch && expandedSearchContainer.style.display === 'block') {
                    expandedSearchContainer.style.display = 'none';
                }
                if (!isClickInsideFilter && expandedFilterContainer.style.display === 'block') {
                    expandedFilterContainer.style.display = 'none';
                }
            });

            // Collapsible Admin Sections Logic
            document.querySelectorAll('.admin-section-header').forEach(header => {
                header.addEventListener('click', () => {
                    const targetId = header.dataset.target;
                    const content = document.getElementById(targetId);
                    const icon = header.querySelector('.icon');

                    if (content.classList.contains('expanded')) {
                        content.classList.remove('expanded');
                        header.classList.add('collapsed');
                        // If header background section is collapsing, disable editing mode
                        if (targetId === 'headerBackgroundContent') {
                            isHeaderBackgroundEditingMode = false;
                            mainHeader.classList.remove('editing-mode');
                        }
                    } else {
                        // Optional: Close other expanded sections
                        document.querySelectorAll('.admin-section-content.expanded').forEach(openContent => {
                            openContent.classList.remove('expanded');
                            openContent.previousElementSibling.classList.add('collapsed');
                            // If another section is open, and it's the header background section, disable its editing mode
                            if (openContent.id === 'headerBackgroundContent') {
                                isHeaderBackgroundEditingMode = false;
                                mainHeader.classList.remove('editing-mode');
                            }
                        });

                        content.classList.add('expanded');
                        header.classList.remove('collapsed');
                        // If header background section is expanding, ensure editing mode is off by default
                        if (targetId === 'headerBackgroundContent') {
                            isHeaderBackgroundEditingMode = false;
                            mainHeader.classList.remove('editing-mode');
                        }
                    }
                });
            });
            // Initialize all admin sections as collapsed by default
            document.querySelectorAll('.admin-section-header').forEach(header => {
                header.classList.add('collapsed');
            });

            // --- Password Toggle Logic ---
            document.querySelectorAll('.password-toggle-icon').forEach(icon => {
                icon.addEventListener('click', () => {
                    const targetId = icon.dataset.target;
                    const passwordInput = document.getElementById(targetId);
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        passwordInput.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            });
        });

        // Function to get the currently visible section (excluding main content)
        function getVisibleSection() {
            if (pageContent.style.display === 'block') return pageContent;
            if (favoritesSection.style.display === 'block') return favoritesSection;
            if (cartSection.style.display === 'block') return cartSection;
            if (loginSection.style.display === 'block') return loginSection;
            if (registerSection.style.display === 'block') return registerSection;
            if (forgotPasswordSection.style.display === 'block') return forgotPasswordSection;
            if (profileSection.style.display === 'block') return profileSection;
            if (adminSection.style.display === 'flex') return adminSection; // Admin section now uses flex
            return pageContent; // Default to pageContent if no specific form/admin section is visible
        }

        // --- HEADER BACKGROUND DRAG LOGIC ---
        mainHeader.addEventListener('mousedown', (e) => {
            // Only enable drag if the background is an image AND editing mode is active
            if (mainHeader.classList.contains('bg-image') && isHeaderBackgroundEditingMode) {
                e.preventDefault(); // Prevent text selection and default browser drag behavior
                isDraggingHeaderBg = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;

                // Get the current background position from the CSS variables
                // We need to parse the percentage values
                const currentX = parseFloat(mainHeader.style.getPropertyValue('--header-bg-position-x')) || 50;
                const currentY = parseFloat(mainHeader.style.getPropertyValue('--header-bg-position-y')) || 50;

                initialBgPosX = currentX;
                initialBgPosY = currentY;

                mainHeader.classList.add('dragging'); // Add dragging class for cursor
            }
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDraggingHeaderBg) return;

            e.preventDefault(); // Prevent default scrolling/selection

            const deltaX = e.clientX - dragStartX;
            const deltaY = e.clientY - dragStartY;

            // Calculate new position in percentages
            // The sensitivity of the drag can be adjusted by the multiplier (e.g., 0.1, 0.2)
            // Divide by offsetWidth/Height to normalize movement to percentage of element size
            let newBgPosX = initialBgPosX + (deltaX / mainHeader.offsetWidth) * 100;
            let newBgPosY = initialBgPosY + (deltaY / mainHeader.offsetHeight) * 100;

            // Clamp values between 0 and 100 to keep the image within reasonable bounds
            newBgPosX = Math.max(0, Math.min(100, newBgPosX));
            newBgPosY = Math.max(0, Math.min(100, newBgPosY));

            // Apply the new position using CSS variables for smooth updates
            mainHeader.style.setProperty('--header-bg-position-x', `${newBgPosX}%`);
            mainHeader.style.setProperty('--header-bg-position-y', `${newBgPosY}%`);

            // Update the mockAppConfig values directly for persistence when saved
            mockAppConfig.headerBackground.positionX = newBgPosX;
            mockAppConfig.headerBackground.positionY = newBgPosY;
        });

        window.addEventListener('mouseup', () => {
            if (isDraggingHeaderBg) {
                isDraggingHeaderBg = false;
                mainHeader.classList.remove('dragging'); // Remove dragging class
                // The position is already updated in mockAppConfig.headerBackground.positionX/Y during mousemove
                // It will be saved when the form is submitted.
            }
        });
    </script>
</body>
</html>
